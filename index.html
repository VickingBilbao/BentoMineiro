<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Empório Bento Mineiro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Fonts e Bootstrap CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 0;
    }
    /* Cabeçalho fixo */
    .header-bar {
      background-color: #a56347;
      color: #fff;
      padding: 10px 15px;
      display: flex;
      align-items: center;
      justify-content: space-between;
      position: sticky;
      top: 0;
      z-index: 999;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .header-left img {
      max-height: 40px;
      border-radius: 4px;
    }
    .header-left h2 {
      font-size: 1.1rem;
      margin: 0;
      font-weight: 600;
    }
    .cart-icon {
      position: relative;
      cursor: pointer;
      color: #fff;
    }
    .cart-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background-color: #dc3545;
      color: #fff;
      font-size: 0.7rem;
      padding: 2px 5px;
      border-radius: 50%;
    }

    /* Navegação de Categorias (chips) */
    .category-chips {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px;
      background-color: #fff;
      border-bottom: 1px solid #ddd;
    }
    .category-chip {
      flex: 0 0 auto;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 8px 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
      color: #a56347;
    }
    .category-chip:hover, .category-chip.active {
      background-color: #ffe6cc;
    }

    /* Indicador de carregamento */
    #loadingIndicator {
      display: none;
      text-align: center;
      margin: 20px 0;
    }

    /* Lista de Produtos – layout horizontal */
    .product-list {
      padding: 10px;
    }
    .product-item {
      display: flex;
      background-color: #fff;
      margin-bottom: 10px;
      border-radius: 6px;
      overflow: hidden;
      box-shadow: 0 1px 3px rgba(0,0,0,0.1);
    }
    .product-item img {
      width: 100px;
      height: 100px;
      object-fit: cover;
      flex-shrink: 0;
    }
    .product-details {
      flex: 1;
      padding: 8px 10px;
      display: flex;
      flex-direction: column;
      justify-content: center;
    }
    .product-title {
      font-size: 1rem;
      font-weight: 600;
      margin: 0 0 4px;
    }
    .product-price {
      color: #8B4513;
      font-weight: 500;
      margin-bottom: 4px;
      display: flex;
      align-items: center;
      gap: 6px;
    }
    /* Tag de Tipo em formato discreto */
    .product-type-label {
      font-size: 0.75rem;
      font-weight: 500;
      color: #fff;
      border-radius: 10px;
      padding: 1px 6px;
      display: inline-flex;
      align-items: center;
      gap: 3px;
    }
    .product-type-label::before {
      content: "•";
      font-weight: bold;
    }
    .tag-pronta {
      background-color: #28a745; /* Verde */
    }
    .tag-encomenda {
      background-color: #007bff; /* Azul */
    }

    .qty-controls {
      margin-top: 4px;
    }
    .qty-btn {
      background-color: #fff;
      border: 1px solid #ff6600;
      color: #ff6600;
      font-weight: 600;
      width: 32px;
      height: 32px;
      border-radius: 6px;
      display: inline-flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
      margin-right: 4px;
    }
    .qty-value {
      min-width: 20px;
      text-align: center;
      font-weight: 500;
      display: inline-block;
    }
    /* Botão ADICIONAR em marrom */
    .add-button button {
      background-color: #8B4513;
      border-color: #8B4513;
      color: #fff;
      font-size: 0.9rem;
    }
    .add-button button:hover {
      background-color: #7a3d11;
      border-color: #7a3d11;
    }

    footer {
      margin-top: 40px;
      padding: 10px;
      text-align: center;
      color: #888;
      font-size: 0.9rem;
    }
    .modal-header, .modal-footer {
      border: none;
    }
    .modal-body .cart-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    .modal-body .form-control {
      margin-bottom: 10px;
    }

    @media (max-width: 576px) {
      .header-left h2 { font-size: 0.9rem; }
    }
  </style>
</head>
<body>

<!-- Cabeçalho -->
<div class="header-bar">
  <div class="header-left">
    <img src="https://i.imgur.com/NVldFUa.png" alt="Logo Bento Mineiro">
    <h2>Empório Bento Mineiro</h2>
  </div>
  <div class="cart-icon" onclick="verCarrinho()">
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#fff" viewBox="0 0 24 24">
      <path d="M7 18c-1.105 0-2 .895-2 2s.895 
               2 2 2c1.105 0 2-.895 2-2s-.895-2-2-2zm10 
               0c-1.105 0-2 .895-2 2s.895 2 2 
               2c1.105 0 2-.895 2-2s-.895-2-2-2zm-13.364
               -16l3.364 6h10.364l3-6h-16.728zm-1.636
               -2h20l-4 8h-12l-4-8z"/>
    </svg>
    <span id="cartCount" class="cart-count">0</span>
  </div>
</div>

<!-- Chips de Categorias -->
<div class="category-chips" id="categoryTabs">
  <div class="category-chip active" onclick="salvarCategoria('Destaques'); filtrarCategoria('Destaques')">Destaques</div>
  <div class="category-chip" onclick="salvarCategoria('Queijos'); filtrarCategoria('Queijos')">Queijos</div>
  <div class="category-chip" onclick="salvarCategoria('Doces'); filtrarCategoria('Doces')">Doces</div>
  <div class="category-chip" onclick="salvarCategoria('Café da Tarde'); filtrarCategoria('Café da Tarde')">Café da Tarde</div>
  <div class="category-chip" onclick="salvarCategoria('Outros'); filtrarCategoria('Outros')">Outros</div>
</div>

<!-- Indicador de Carregamento -->
<div id="loadingIndicator">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Carregando...</span>
  </div>
  <p>Carregando produtos...</p>
</div>

<!-- Lista de Produtos -->
<div class="product-list container" id="productsContainer"></div>

<!-- Modal do Carrinho -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Carrinho</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="cartItems"></div>
        <hr>
        <div class="d-flex justify-content-between">
          <strong>Total:</strong>
          <span id="cartTotal">R$ 0,00</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="limparCarrinho()">Limpar Carrinho</button>
        <button class="btn btn-success" onclick="mostrarFormularioDados()">Finalizar Pedido</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal de Dados, Resumo e Cupom -->
<div class="modal fade" id="dadosModal" tabindex="-1" aria-labelledby="dadosModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seus Dados e Resumo do Pedido</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <!-- Formulário de Dados -->
        <form id="formDados">
          <input type="text" class="form-control" id="nomeDados" placeholder="Nome" required>
          <input type="text" class="form-control" id="telefoneDados" placeholder="Telefone" required>
          <input type="text" class="form-control" id="cepDados" placeholder="CEP (ex: 00000-000)" required>
          <input type="text" class="form-control" id="enderecoDados" placeholder="Endereço" required>
          <input type="text" class="form-control" id="numeroDados" placeholder="Número" required>
          <input type="text" class="form-control" id="complementoDados" placeholder="Complemento">
          <textarea class="form-control" id="observacoesDados" rows="3" placeholder="Observações"></textarea>
        </form>
        <hr>
        <!-- Resumo do Pedido -->
        <div id="orderSummary"></div>
        <div id="orderTotal"></div>
        <hr>
        <!-- Cupom de Desconto -->
        <div class="mb-2">
          <input type="text" class="form-control" id="cupomDados" placeholder="Cupom de Desconto">
          <button class="btn btn-primary btn-sm mt-2" onclick="aplicarCupom()">Aplicar Cupom</button>
          <div id="cupomFeedback"></div>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
        <button class="btn btn-success" onclick="finalizarPedidoWhatsApp()">Finalizar Pedido</button>
      </div>
    </div>
  </div>
</div>

<footer>
  &copy; 2025 Bento Mineiro. Todos os direitos reservados.
</footer>

<!-- Bootstrap JS (Bundle com Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  /* ------------------------------------------------------------------
    CONFIGURAÇÕES E VARIÁVEIS GLOBAIS
  ------------------------------------------------------------------ */
  const API_BASE_URL = "SUA_URL_DO_SCRIPT"; // Substitua pela URL real do Apps Script
  const CACHE_KEY = "bentoMineiroProdutos";
  const CACHE_TIMESTAMP_KEY = "bentoMineiroProdutosTimestamp";
  const CACHE_EXPIRATION = 60000; // 1 minuto

  let allProducts = [];
  let cart = {};
  let userData = {};
  let currentCategory = localStorage.getItem("bentoMineiroCurrentCategory") || "Destaques";
  let allCupons = [];
  let cupomAplicado = null;

  /* ------------------------------------------------------------------
    FUNÇÕES DE CACHE E BUSCA DE PRODUTOS
  ------------------------------------------------------------------ */
  async function fetchProdutosCache() {
    const now = Date.now();
    const cachedData = localStorage.getItem(CACHE_KEY);
    const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
    if (cachedData && cachedTimestamp && (now - cachedTimestamp < CACHE_EXPIRATION)) {
      return JSON.parse(cachedData);
    } else {
      const response = await fetch(API_BASE_URL + "?action=produtos");
      const produtos = await response.json();
      localStorage.setItem(CACHE_KEY, JSON.stringify(produtos));
      localStorage.setItem(CACHE_TIMESTAMP_KEY, now);
      return produtos;
    }
  }

  function transformarDados(data) {
    if (!Array.isArray(data) || data.length < 2) return [];
    const headers = data[0];
    return data.slice(1).map(row => {
      let obj = {};
      headers.forEach((header, index) => {
        obj[header] = row[index];
      });
      return obj;
    });
  }

  /* ------------------------------------------------------------------
    FUNÇÕES DE CUPOM
  ------------------------------------------------------------------ */
  async function fetchCupons() {
    try {
      const response = await fetch(API_BASE_URL + "?action=cupons");
      const cupons = await response.json();
      if (!Array.isArray(cupons) || cupons.length < 2) return [];
      const headers = cupons[0];
      return cupons.slice(1).map(row => {
        let obj = {};
        headers.forEach((h, i) => { obj[h] = row[i]; });
        return obj;
      });
    } catch (error) {
      console.error("Erro ao buscar cupons:", error);
      return [];
    }
  }
  function aplicarCupom() {
    const cupomDigitado = document.getElementById("cupomDados").value.trim().toUpperCase();
    const cupomFeedbackEl = document.getElementById("cupomFeedback");
    const totalGeral = parseFloat(document.getElementById("orderSummary").dataset.total || "0");
    let desconto = 0;
    let foundCupom = allCupons.find(c => c.Codigo && c.Codigo.toString().trim().toUpperCase() === cupomDigitado);
    if (cupomDigitado && !foundCupom) {
      cupomFeedbackEl.textContent = "Cupom inválido";
      cupomFeedbackEl.style.color = "#d9534f";
      cupomAplicado = null;
    } else if (foundCupom) {
      desconto = converterDesconto(foundCupom.Desconto, totalGeral);
      cupomFeedbackEl.textContent = `Cupom ${foundCupom.Codigo} aplicado! Desconto: R$ ${desconto.toFixed(2)}`;
      cupomFeedbackEl.style.color = "#28a745";
      cupomAplicado = { cupom: foundCupom.Codigo, desconto };
    } else {
      cupomFeedbackEl.textContent = "";
      cupomAplicado = null;
    }
    if (desconto > 0) {
      const totalFinal = totalGeral - desconto;
      document.getElementById("orderTotal").innerHTML = `<strong>Total com Desconto: R$ ${totalFinal.toFixed(2)}</strong>`;
    } else {
      document.getElementById("orderTotal").textContent = "";
    }
  }
  function converterDesconto(desc, valorTotal) {
    const d = desc.toString().trim();
    let num = parseFloat(d.replace("%", ""));
    if (d.includes("%")) {
      return valorTotal * (num / 100);
    } else {
      return valorTotal * num;
    }
  }

  /* ------------------------------------------------------------------
    CARREGAR E SALVAR CARRINHO E DADOS
  ------------------------------------------------------------------ */
  function salvarCart() {
    localStorage.setItem("bentoMineiroCart", JSON.stringify(cart));
  }
  function carregarCart() {
    const data = localStorage.getItem("bentoMineiroCart");
    cart = data ? JSON.parse(data) : {};
    atualizarCartCount();
  }
  function salvarUserData() {
    localStorage.setItem("bentoMineiroUserData", JSON.stringify(userData));
  }
  function carregarUserData() {
    const data = localStorage.getItem("bentoMineiroUserData");
    userData = data ? JSON.parse(data) : {};
  }

  /* ------------------------------------------------------------------
    LÓGICA PRINCIPAL
  ------------------------------------------------------------------ */
  document.addEventListener("DOMContentLoaded", async () => {
    carregarUserData();
    carregarCart();
    mostrarCarregando(true);
    try {
      const data = await fetchProdutosCache();
      allProducts = transformarDados(data);
      allCupons = await fetchCupons();
      filtrarCategoria(currentCategory);
    } catch (error) {
      console.error("Erro ao carregar produtos:", error);
    } finally {
      mostrarCarregando(false);
    }
    // CEP auto-complete
    document.getElementById("cepDados").addEventListener("blur", async function() {
      const cep = this.value.replace(/\D/g, '');
      if (cep.length === 8) {
        try {
          const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
          const data = await response.json();
          if (!data.erro) {
            document.getElementById("enderecoDados").value = `${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}`;
          } else {
            alert("CEP não encontrado.");
          }
        } catch (error) {
          console.error("Erro ao buscar CEP:", error);
        }
      }
    });
  });

  /* ------------------------------------------------------------------
    EXIBIR PRODUTOS
  ------------------------------------------------------------------ */
  function exibirProdutos(produtos) {
    const container = document.getElementById("productsContainer");
    container.innerHTML = "";
    produtos.forEach(prod => {
      let itemQty = 0;
      if (cart[prod.ID]) itemQty = cart[prod.ID].quantidade;
      
      const productItem = document.createElement("div");
      productItem.className = "product-item";

      // Imagem
      const imgEl = document.createElement("img");
      imgEl.src = prod.Imagem;
      imgEl.alt = prod.Nome;

      // Detalhes
      const detailsDiv = document.createElement("div");
      detailsDiv.className = "product-details";

      // Título
      const titleEl = document.createElement("div");
      titleEl.className = "product-title";
      titleEl.textContent = prod.Nome;

      // Preço + Tag de tipo
      const priceEl = document.createElement("div");
      priceEl.className = "product-price";
      priceEl.textContent = "R$ " + parseFloat(prod.Valor).toFixed(2);
      // Tag de tipo discreta
      if (prod.Tipo) {
        const tipoNormalized = prod.Tipo.toString().trim().toLowerCase();
        const tagEl = document.createElement("span");
        tagEl.className = "product-type-label " + (tipoNormalized === "pronta entrega" ? "tag-pronta" : "tag-encomenda");
        tagEl.textContent = prod.Tipo;
        priceEl.appendChild(tagEl);
      }

      detailsDiv.appendChild(titleEl);
      detailsDiv.appendChild(priceEl);

      // Seletor de quantidade ou botão ADICIONAR
      const controlDiv = document.createElement("div");
      if (itemQty > 0) {
        controlDiv.className = "qty-controls";
        controlDiv.innerHTML = `
          <div class="qty-btn" onclick="alterarQuantidade('${prod.ID}', -1)">-</div>
          <div class="qty-value" id="qty-${prod.ID}">${itemQty}</div>
          <div class="qty-btn" onclick="alterarQuantidade('${prod.ID}', 1)">+</div>
        `;
      } else {
        controlDiv.className = "add-button";
        controlDiv.innerHTML = `<button class="btn btn-brown btn-sm" onclick="adicionarAoCarrinho('${prod.ID}')">ADICIONAR</button>`;
      }
      detailsDiv.appendChild(controlDiv);

      // Monta o item
      productItem.appendChild(imgEl);
      productItem.appendChild(detailsDiv);
      container.appendChild(productItem);
    });
    // Atualiza quantidades do carrinho
    for (const pid in cart) {
      const el = document.getElementById(`qty-${pid}`);
      if (el) el.textContent = cart[pid].quantidade;
    }
  }

  /* ------------------------------------------------------------------
    FILTRAR CATEGORIA
  ------------------------------------------------------------------ */
  function filtrarCategoria(cat) {
    currentCategory = cat;
    localStorage.setItem("bentoMineiroCurrentCategory", cat);
    let filtrados = [];
    if (cat.toLowerCase() === "destaques") {
      filtrados = allProducts.filter(p => p.Destaque && p.Destaque.toString().toLowerCase() === "sim");
    } else {
      filtrados = allProducts.filter(p => p.Categoria && p.Categoria.toString().toLowerCase() === cat.toLowerCase());
    }
    exibirProdutos(filtrados);

    // Atualiza aparência dos chips
    document.querySelectorAll(".category-chip").forEach(chip => {
      chip.classList.remove("active");
      if(chip.textContent.trim().toLowerCase() === cat.toLowerCase()){
        chip.classList.add("active");
      }
    });
  }

  /* ------------------------------------------------------------------
    ADICIONAR AO CARRINHO
  ------------------------------------------------------------------ */
  function adicionarAoCarrinho(productID) {
    const produto = allProducts.find(p => p.ID == productID);
    if (!produto) return;
    cart[productID] = { produto, quantidade: 1 };
    salvarCart();
    atualizarCartCount();
    filtrarCategoria(currentCategory);
  }

  /* ------------------------------------------------------------------
    ALTERAR QUANTIDADE
  ------------------------------------------------------------------ */
  function alterarQuantidade(productID, delta) {
    let item = cart[productID];
    if (!item) return;
    item.quantidade += delta;
    if (item.quantidade <= 0) {
      delete cart[productID];
    }
    salvarCart();
    atualizarCartCount();
    filtrarCategoria(currentCategory);
  }

  /* ------------------------------------------------------------------
    ATUALIZAR CONTAGEM
  ------------------------------------------------------------------ */
  function atualizarCartCount() {
    let total = 0;
    for (const pid in cart) total += cart[pid].quantidade;
    document.getElementById("cartCount").textContent = total;
  }

  /* ------------------------------------------------------------------
    VER CARRINHO
  ------------------------------------------------------------------ */
  function verCarrinho() {
    const cartItemsEl = document.getElementById("cartItems");
    const cartTotalEl = document.getElementById("cartTotal");
    cartItemsEl.innerHTML = "";
    let total = 0;
    for (const pid in cart) {
      const item = cart[pid];
      if (item.quantidade > 0) {
        const sub = parseFloat(item.produto.Valor) * item.quantidade;
        total += sub;
        cartItemsEl.innerHTML += `
          <div class="cart-item">
            <span>${item.produto.Nome} (x${item.quantidade})</span>
            <strong>R$ ${sub.toFixed(2)}</strong>
          </div>
        `;
      }
    }
    cartTotalEl.textContent = "R$ " + total.toFixed(2);
    new bootstrap.Modal(document.getElementById("cartModal")).show();
  }

  /* ------------------------------------------------------------------
    LIMPAR CARRINHO
  ------------------------------------------------------------------ */
  function limparCarrinho() {
    cart = {};
    localStorage.removeItem("bentoMineiroCart");
    document.getElementById("cartItems").innerHTML = "";
    document.getElementById("cartTotal").textContent = "R$ 0,00";
    atualizarCartCount();
    filtrarCategoria(currentCategory);
  }

  /* ------------------------------------------------------------------
    MOSTRAR FORM DE DADOS
  ------------------------------------------------------------------ */
  function mostrarFormularioDados() {
    new bootstrap.Modal(document.getElementById("cartModal")).hide();
    document.getElementById("nomeDados").value = userData.nome || "";
    document.getElementById("telefoneDados").value = userData.telefone || "";
    document.getElementById("cepDados").value = userData.cep || "";
    document.getElementById("enderecoDados").value = userData.endereco || "";
    document.getElementById("numeroDados").value = userData.numero || "";
    document.getElementById("complementoDados").value = userData.complemento || "";
    document.getElementById("observacoesDados").value = userData.obs || "";
    document.getElementById("cupomDados").value = "";
    document.getElementById("cupomFeedback").textContent = "";
    exibirResumoPedido();
    new bootstrap.Modal(document.getElementById("dadosModal")).show();
  }

  /* ------------------------------------------------------------------
    EXIBIR RESUMO
  ------------------------------------------------------------------ */
  function exibirResumoPedido() {
    let resumo = "";
    let totalGeral = 0;
    let categoriasCarrinho = {};
    for (const pid in cart) {
      const item = cart[pid];
      if (item.quantidade > 0) {
        const catRaw = item.produto.Categoria || "Outros";
        const catNorm = catRaw.toString().trim() || "Outros";
        if (!categoriasCarrinho[catNorm]) {
          categoriasCarrinho[catNorm] = [];
        }
        categoriasCarrinho[catNorm].push(item);
      }
    }
    for (const cat in categoriasCarrinho) {
      resumo += `<strong>${cat}</strong><br>`;
      let subtotalCat = 0;
      categoriasCarrinho[cat].forEach(item => {
        const subtotal = parseFloat(item.produto.Valor) * item.quantidade;
        subtotalCat += subtotal;
        resumo += `- ${item.produto.Nome} (x${item.quantidade}) = R$ ${subtotal.toFixed(2)}<br>`;
      });
      resumo += `Subtotal ${cat}: R$ ${subtotalCat.toFixed(2)}<br><br>`;
      totalGeral += subtotalCat;
    }
    resumo += `<strong>Total Geral: R$ ${totalGeral.toFixed(2)}</strong>`;
    document.getElementById("orderSummary").innerHTML = resumo;
    document.getElementById("orderSummary").dataset.total = totalGeral;
    document.getElementById("orderTotal").textContent = "";
  }

  /* ------------------------------------------------------------------
    FINALIZAR PEDIDO
  ------------------------------------------------------------------ */
  function finalizarPedidoWhatsApp() {
    userData.nome = document.getElementById("nomeDados").value;
    userData.telefone = document.getElementById("telefoneDados").value;
    userData.cep = document.getElementById("cepDados").value;
    userData.endereco = document.getElementById("enderecoDados").value;
    userData.numero = document.getElementById("numeroDados").value;
    userData.complemento = document.getElementById("complementoDados").value;
    userData.obs = document.getElementById("observacoesDados").value;
    salvarUserData();

    const totalGeral = parseFloat(document.getElementById("orderSummary").dataset.total || "0");
    let desconto = cupomAplicado ? cupomAplicado.desconto : 0;
    let totalFinal = totalGeral - desconto;

    let msg = "*Pedido Bento Mineiro*\n\n";
    msg += `*Nome:* ${userData.nome}\n`;
    msg += `*Telefone:* ${userData.telefone}\n`;
    msg += `*CEP:* ${userData.cep}\n`;
    msg += `*Endereço:* ${userData.endereco}\n`;
    msg += `*Número:* ${userData.numero}\n`;
    msg += `*Complemento:* ${userData.complemento}\n\n`;

    let categoriasCarrinho = {};
    for (const pid in cart) {
      const item = cart[pid];
      if (item.quantidade > 0) {
        const catRaw = item.produto.Categoria || "Outros";
        const catNorm = catRaw.toString().trim() || "Outros";
        if (!categoriasCarrinho[catNorm]) {
          categoriasCarrinho[catNorm] = [];
        }
        categoriasCarrinho[catNorm].push(item);
      }
    }
    for (const cat in categoriasCarrinho) {
      msg += `*${cat}*\n`;
      let subtotalCat = 0;
      categoriasCarrinho[cat].forEach(item => {
        const subtotal = parseFloat(item.produto.Valor) * item.quantidade;
        subtotalCat += subtotal;
        msg += `- ${item.produto.Nome} (x${item.quantidade}) = R$ ${subtotal.toFixed(2)}\n`;
      });
      msg += `Subtotal ${cat}: R$ ${subtotalCat.toFixed(2)}\n\n`;
    }

    if (cupomAplicado) {
      msg += `*Cupom ${cupomAplicado.cupom} aplicado: -R$ ${cupomAplicado.desconto.toFixed(2)}*\n\n`;
    }
    msg += `*Total Geral:* R$ ${totalFinal.toFixed(2)}\n\n`;
    msg += `*Observações:* ${userData.obs}\n\n`;
    msg += "_Valor total sem frete - Consulte o valor de frete na hora de finalizar o pagamento_\n";

    const url = "https://wa.me/5511917420830?text=" + encodeURIComponent(msg);
    window.open(url, "_blank");
  }

  /* ------------------------------------------------------------------
    AUXILIAR
  ------------------------------------------------------------------ */
  function mostrarCarregando(status) {
    document.getElementById("loadingIndicator").style.display = status ? "block" : "none";
  }
</script>
</body>
</html>