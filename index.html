<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Bento Mineiro - Nova Loja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Fonts e Bootstrap CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f7f7f7;
      margin: 0; padding: 0;
    }
    /* Header com Logo, Slogan e Carrinho */
    .header-bar {
      background-color: #a56347; /* Cor de fundo principal */
      color: #fff;
      padding: 10px;
      display: flex;
      align-items: center;
      justify-content: space-between;
    }
    .header-left {
      display: flex;
      align-items: center;
      gap: 10px; /* Aumenta o espaço entre logo e texto */
    }
    .header-left img {
      max-height: 50px;
    }
    .header-left h2 {
      font-size: 1rem;
      margin: 0;
      font-weight: 500;
    }
    .cart-icon {
      position: relative;
      cursor: pointer;
      color: #fff;
    }
    .cart-count {
      position: absolute;
      top: -6px;
      right: -6px;
      background-color: #dc3545;
      color: #fff;
      font-size: 0.7rem;
      padding: 2px 5px;
      border-radius: 50%;
    }
    /* Chips de categoria */
    .category-chips {
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding: 10px;
      background-color: #fff;
    }
    .category-chip {
      flex: 0 0 auto;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 8px 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
      color: #a56347;
    }
    .category-chip:hover {
      background-color: #ffe6cc;
    }
    /* Indicador de carregamento */
    #loadingIndicator {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    /* Cards de produto */
    .product-card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 20px;
      background-color: #fff;
    }
    .product-card img {
      width: 100%;
      aspect-ratio: 4 / 1;
      object-fit: cover;
    }
    .product-body {
      padding: 10px;
    }
    .product-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .product-price {
      color: #8B4513;
      font-weight: 500;
      margin-bottom: 8px;
    }
    /* Botões de quantidade */
    .qty-controls {
      display: flex;
      align-items: center;
      gap: 10px;
    }
    .qty-btn {
      background-color: #fff;
      border: 1px solid #ff6600;
      color: #ff6600;
      font-weight: 600;
      width: 30px;
      height: 30px;
      border-radius: 6px;
      display: flex;
      align-items: center;
      justify-content: center;
      cursor: pointer;
    }
    .qty-value {
      min-width: 20px;
      text-align: center;
      font-weight: 500;
    }
    /* Modal do Carrinho e Dados */
    .modal-header, .modal-footer {
      border: none;
    }
    .modal-body .cart-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    /* Rodapé */
    footer {
      margin-top: 30px;
      padding: 10px;
      text-align: center;
      color: #888;
      font-size: 0.9rem;
    }
    @media (max-width: 576px) {
      .header-left h2 {
        font-size: 0.9rem;
      }
    }
  </style>
</head>
<body>

<!-- Header com Logo, Slogan e Carrinho -->
<div class="header-bar">
  <div class="header-left">
    <img src="https://i.imgur.com/NVldFUa.png" alt="Logo Bento Mineiro">
    <h2>Seja bem vindo em nossa loja!</h2>
  </div>
  <div class="cart-icon" onclick="verCarrinho()">
    <!-- Ícone do carrinho -->
    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" fill="#fff" viewBox="0 0 24 24">
      <path d="M7 18c-1.105 0-2 .895-2 2s.895 2 2 
               2c1.105 0 2-.895 2-2s-.895-2-2-2zm10 
               0c-1.105 0-2 .895-2 2s.895 2 2 
               2c1.105 0 2-.895 2-2s-.895-2-2-2zm-13.364 
               -16l3.364 6h10.364l3-6h-16.728zm-1.636 
               -2h20l-4 8h-12l-4-8z"/>
    </svg>
    <span id="cartCount" class="cart-count">0</span>
  </div>
</div>

<!-- Chips de Categoria -->
<div class="category-chips">
  <div class="category-chip" onclick="filtrarCategoria('Destaques')">Destaques</div>
  <div class="category-chip" onclick="filtrarCategoria('Pronta Entrega')">Pronta Entrega</div>
  <div class="category-chip" onclick="filtrarCategoria('Encomendas')">Encomendas</div>
  <div class="category-chip" onclick="filtrarCategoria('Produtos Especiais - Queijos Premiados Boníssimo')">Produtos Especiais</div>
</div>

<!-- Indicador de Carregamento -->
<div id="loadingIndicator">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Carregando...</span>
  </div>
  <p>Carregando produtos...</p>
</div>

<!-- Lista de Produtos -->
<div class="container">
  <div class="row" id="productsContainer">
    <!-- Cards de produto gerados dinamicamente -->
  </div>
</div>

<!-- Modal do Carrinho -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Carrinho</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="cartItems"></div>
        <hr>
        <div class="d-flex justify-content-between">
          <strong>Total:</strong>
          <span id="cartTotal">R$ 0,00</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-danger" onclick="limparCarrinho()">Limpar Carrinho</button>
        <button class="btn btn-success" onclick="mostrarFormularioDados()">Finalizar Pedido</button>
      </div>
    </div>
  </div>
</div>

<!-- Modal Formulário de Dados -->
<div class="modal fade" id="dadosModal" tabindex="-1" aria-labelledby="dadosModalLabel" aria-hidden="true">
  <div class="modal-dialog">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title">Seus Dados</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <form id="formDados">
          <div class="mb-3">
            <label for="nomeDados" class="form-label">Nome:</label>
            <input type="text" class="form-control" id="nomeDados" required>
          </div>
          <div class="mb-3">
            <label for="telefoneDados" class="form-label">Telefone:</label>
            <input type="text" class="form-control" id="telefoneDados" required>
          </div>
          <div class="mb-3">
            <label for="cepDados" class="form-label">CEP:</label>
            <input type="text" class="form-control" id="cepDados" placeholder="00000-000" required>
          </div>
          <div class="mb-3">
            <label for="enderecoDados" class="form-label">Endereço:</label>
            <input type="text" class="form-control" id="enderecoDados" required>
          </div>
          <div class="mb-3">
            <label for="numeroDados" class="form-label">Número:</label>
            <input type="text" class="form-control" id="numeroDados" required>
          </div>
          <div class="mb-3">
            <label for="complementoDados" class="form-label">Complemento:</label>
            <input type="text" class="form-control" id="complementoDados">
          </div>
          <div class="mb-3">
            <label for="observacoesDados" class="form-label">Observações:</label>
            <textarea class="form-control" id="observacoesDados" rows="3"></textarea>
          </div>
        </form>
      </div>
      <div class="modal-footer">
        <button class="btn btn-secondary" data-bs-dismiss="modal">Voltar</button>
        <button class="btn btn-success" onclick="finalizarPedidoWhatsApp()">Finalizar no WhatsApp</button>
      </div>
    </div>
  </div>
</div>

<footer>
  &copy; 2025 Bento Mineiro. Todos os direitos reservados.
</footer>

<!-- Bootstrap JS (Bundle com Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ==============================================
   CONFIGURAÇÕES E VARIÁVEIS GLOBAIS
============================================== */
const API_BASE_URL = "https://script.google.com/macros/s/AKfycbzoRWay1-1W0C5weOZcISg1AfYPJ8SHtfrOoZhoxIrbZDC3MrrsIIyRnrnHjqdyKc8u/exec"; // Ajuste para sua URL
const CACHE_KEY = "bentoMineiroProdutos";
const CACHE_TIMESTAMP_KEY = "bentoMineiroProdutosTimestamp";
const CACHE_EXPIRATION = 10 * 60 * 1000; // 10 minutos

let allProducts = [];
let cart = {}; // { productID: { produto, quantidade } }
let userData = {};

/* ==============================================
   INICIALIZAÇÃO
============================================== */
document.addEventListener("DOMContentLoaded", async () => {
  carregarUserData();
  mostrarCarregando(true);
  try {
    allProducts = await fetchProdutosCache();
    exibirProdutos(allProducts);
  } catch (error) {
    console.error("Erro ao carregar produtos:", error);
  } finally {
    mostrarCarregando(false);
  }
  // CEP autocomplete
  document.getElementById("cepDados").addEventListener("blur", async function() {
    const cep = this.value.replace(/\D/g, '');
    if (cep.length === 8) {
      try {
        const response = await fetch(`https://viacep.com.br/ws/${cep}/json/`);
        const data = await response.json();
        if (!data.erro) {
          document.getElementById("enderecoDados").value = `${data.logradouro}, ${data.bairro}, ${data.localidade} - ${data.uf}`;
        } else {
          alert("CEP não encontrado.");
        }
      } catch (error) {
        console.error("Erro ao buscar CEP:", error);
      }
    }
  });
});

/* ==============================================
   FUNÇÕES DE CACHE E BUSCA DE PRODUTOS
============================================== */
async function fetchProdutosCache() {
  const now = Date.now();
  const cachedData = localStorage.getItem(CACHE_KEY);
  const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
  if (cachedData && cachedTimestamp && (now - cachedTimestamp < CACHE_EXPIRATION)) {
    return JSON.parse(cachedData);
  } else {
    const response = await fetch(API_BASE_URL + "?type=produtos");
    const produtos = await response.json();
    localStorage.setItem(CACHE_KEY, JSON.stringify(produtos));
    localStorage.setItem(CACHE_TIMESTAMP_KEY, now);
    return produtos;
  }
}

/* ==============================================
   EXIBIR PRODUTOS
============================================== */
function exibirProdutos(produtos) {
  const container = document.getElementById("productsContainer");
  container.innerHTML = "";
  produtos.forEach(prod => {
    const col = document.createElement("div");
    col.className = "col-6 col-md-4 col-lg-3";
    col.innerHTML = `
      <div class="product-card p-2">
        <img src="${prod.Imagem}" alt="${prod.Nome}">
        <div class="product-body">
          <div class="product-title">${prod.Nome}</div>
          <div class="product-price">R$ ${parseFloat(prod.Valor).toFixed(2)}</div>
          <div class="qty-controls" data-id="${prod.ID}">
            <div class="qty-btn" onclick="alterarQuantidade('${prod.ID}', -1)">-</div>
            <div class="qty-value" id="qty-${prod.ID}">0</div>
            <div class="qty-btn" onclick="alterarQuantidade('${prod.ID}', 1)">+</div>
          </div>
        </div>
      </div>
    `;
    container.appendChild(col);
  });
}

/* ==============================================
   FILTRAR CATEGORIA (inclui Destaques)
============================================== */
function filtrarCategoria(cat) {
  if (cat === "Destaques") {
    // Ex: 1 produto de cada
    const categorias = [
      "Pronta Entrega",
      "Encomendas",
      "Produtos Especiais - Queijos Premiados Boníssimo"
    ];
    let destaqueProds = [];
    categorias.forEach(c => {
      const found = allProducts.find(p => p.Categoria === c);
      if (found) destaqueProds.push(found);
    });
    exibirProdutos(destaqueProds);
  } else {
    const filtrados = allProducts.filter(p => p.Categoria === cat);
    exibirProdutos(filtrados);
  }
}

/* ==============================================
   QUANTIDADE / CARRINHO
============================================== */
function alterarQuantidade(productID, delta) {
  let item = cart[productID];
  if (!item) {
    const produto = allProducts.find(p => p.ID == productID);
    if (!produto) return;
    cart[productID] = { produto, quantidade: 0 };
    item = cart[productID];
  }
  item.quantidade += delta;
  if (item.quantidade < 0) item.quantidade = 0;
  document.getElementById(`qty-${productID}`).textContent = item.quantidade;
  atualizarCartCount();
}

function atualizarCartCount() {
  let totalItens = 0;
  for (const pid in cart) {
    totalItens += cart[pid].quantidade;
  }
  document.getElementById("cartCount").textContent = totalItens;
}

function verCarrinho() {
  // Monta modal
  const cartItemsEl = document.getElementById("cartItems");
  const cartTotalEl = document.getElementById("cartTotal");
  cartItemsEl.innerHTML = "";
  let total = 0;
  for (const pid in cart) {
    const item = cart[pid];
    if (item.quantidade > 0) {
      const subtotal = parseFloat(item.produto.Valor) * item.quantidade;
      total += subtotal;
      cartItemsEl.innerHTML += `
        <div class="cart-item">
          <span>${item.produto.Nome} (x${item.quantidade})</span>
          <strong>R$ ${subtotal.toFixed(2)}</strong>
        </div>
      `;
    }
  }
  cartTotalEl.textContent = "R$ " + total.toFixed(2);
  const modalEl = new bootstrap.Modal(document.getElementById("cartModal"));
  modalEl.show();
}

function limparCarrinho() {
  cart = {};
  document.getElementById("cartItems").innerHTML = "";
  document.getElementById("cartTotal").textContent = "R$ 0,00";
  // Zera UI
  allProducts.forEach(p => {
    const el = document.getElementById(`qty-${p.ID}`);
    if (el) el.textContent = "0";
  });
  atualizarCartCount();
}

/* ==============================================
   FINALIZAR PEDIDO
============================================== */
function mostrarFormularioDados() {
  // Fecha cartModal
  const cartModal = bootstrap.Modal.getInstance(document.getElementById("cartModal"));
  cartModal.hide();
  // Carrega userData
  document.getElementById("nomeDados").value = userData.nome || "";
  document.getElementById("telefoneDados").value = userData.telefone || "";
  document.getElementById("cepDados").value = userData.cep || "";
  document.getElementById("enderecoDados").value = userData.endereco || "";
  document.getElementById("numeroDados").value = userData.numero || "";
  document.getElementById("complementoDados").value = userData.complemento || "";
  document.getElementById("observacoesDados").value = userData.obs || "";
  // Abre dadosModal
  const dadosModal = new bootstrap.Modal(document.getElementById("dadosModal"));
  dadosModal.show();
}

function finalizarPedidoWhatsApp() {
  // Salva dados no localStorage
  userData.nome = document.getElementById("nomeDados").value;
  userData.telefone = document.getElementById("telefoneDados").value;
  userData.cep = document.getElementById("cepDados").value;
  userData.endereco = document.getElementById("enderecoDados").value;
  userData.numero = document.getElementById("numeroDados").value;
  userData.complemento = document.getElementById("complementoDados").value;
  userData.obs = document.getElementById("observacoesDados").value;
  salvarUserData();

  // Monta mensagem
  let msg = "*Pedido Bento Mineiro*\n\n";
  msg += `*Nome:* ${userData.nome}\n`;
  msg += `*Telefone:* ${userData.telefone}\n`;
  msg += `*CEP:* ${userData.cep}\n`;
  msg += `*Endereço:* ${userData.endereco}\n`;
  msg += `*Número:* ${userData.numero}\n`;
  msg += `*Complemento:* ${userData.complemento}\n\n`;
  let total = 0;
  for (const pid in cart) {
    const item = cart[pid];
    if (item.quantidade > 0) {
      const subtotal = parseFloat(item.produto.Valor) * item.quantidade;
      total += subtotal;
      msg += `- ${item.produto.Nome} (x${item.quantidade}) = R$ ${subtotal.toFixed(2)}\n`;
    }
  }
  msg += `\n*Total:* R$ ${total.toFixed(2)}\n`;
  msg += `\n*Observações:* ${userData.obs}\n`;
  const url = "https://wa.me/5511984193457?text=" + encodeURIComponent(msg);
  window.open(url, "_blank");
}

/* ==============================================
   SALVAR/CARREGAR USER DATA
============================================== */
function salvarUserData() {
  localStorage.setItem("bentoMineiroUserData", JSON.stringify(userData));
}
function carregarUserData() {
  const data = localStorage.getItem("bentoMineiroUserData");
  if (data) {
    userData = JSON.parse(data);
  } else {
    userData = {};
  }
}

/* ==============================================
   OUTROS
============================================== */
function mostrarCarregando(status) {
  document.getElementById("loadingIndicator").style.display = status ? "block" : "none";
}
</script>

</body>
</html>