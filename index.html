<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Bento Mineiro - Nova Loja</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Google Fonts e Bootstrap CSS -->
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">

  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f7f7f7;
      margin: 0;
      padding: 0;
    }
    /* Navbar */
    .navbar-brand img {
      max-height: 50px;
    }
    .cart-icon {
      position: relative;
      cursor: pointer;
    }
    .cart-count {
      position: absolute;
      top: -8px;
      right: -8px;
      background-color: #dc3545;
      color: #fff;
      font-size: 0.7rem;
      padding: 2px 5px;
      border-radius: 50%;
    }
    /* Banner */
    .banner {
      width: 100%;
      height: 180px;
      background: url('https://i.imgur.com/zKjhWjb.jpg') center/cover no-repeat;
      position: relative;
      border-radius: 8px;
      margin-bottom: 20px;
    }
    .banner-overlay {
      position: absolute;
      top: 0; left: 0; right: 0; bottom: 0;
      background-color: rgba(0,0,0,0.3);
      border-radius: 8px;
    }
    .banner-text {
      position: absolute;
      bottom: 10px;
      left: 20px;
      color: #fff;
      font-size: 1.3rem;
      font-weight: 600;
    }
    /* Categorias em formato de chips */
    .category-chips {
      margin: 10px 0;
      display: flex;
      gap: 10px;
      overflow-x: auto;
      padding-bottom: 10px;
    }
    .category-chip {
      flex: 0 0 auto;
      background-color: #fff;
      border: 1px solid #ddd;
      border-radius: 20px;
      padding: 8px 16px;
      font-weight: 500;
      cursor: pointer;
      transition: background-color 0.2s;
      white-space: nowrap;
    }
    .category-chip:hover {
      background-color: #ffe6cc;
    }
    /* Cards de produto */
    .product-card {
      border: none;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      overflow: hidden;
      margin-bottom: 20px;
      background-color: #fff;
    }
    .product-card img {
      width: 100%;
      aspect-ratio: 4 / 1;
      object-fit: cover;
    }
    .product-body {
      padding: 10px;
    }
    .product-title {
      font-size: 1rem;
      font-weight: 600;
      margin-bottom: 5px;
    }
    .product-price {
      color: #8B4513;
      font-weight: 500;
      margin-bottom: 8px;
    }
    .product-description {
      font-size: 0.9rem;
      color: #666;
      margin-bottom: 8px;
    }
    .btn-add {
      background-color: #ff6600;
      border: none;
      color: #fff;
      font-weight: 600;
      border-radius: 20px;
      padding: 8px 16px;
    }
    .btn-add:hover {
      background-color: #e65c00;
    }
    /* Indicador de carregamento */
    #loadingIndicator {
      display: none;
      text-align: center;
      margin: 20px 0;
    }
    /* Modal do carrinho */
    .modal-body .cart-item {
      display: flex;
      justify-content: space-between;
      margin-bottom: 10px;
    }
    /* Responsividade */
    @media (max-width: 576px) {
      .banner {
        height: 120px;
      }
      .banner-text {
        font-size: 1rem;
      }
    }
  </style>
</head>
<body>

<!-- Navbar -->
<nav class="navbar navbar-expand-lg navbar-light bg-white shadow-sm">
  <div class="container">
    <a class="navbar-brand" href="#">
      <img src="https://i.imgur.com/NVldFUa.png" alt="Logo Bento Mineiro">
    </a>
    <button class="navbar-toggler" type="button" data-bs-toggle="collapse" data-bs-target="#navbarNav">
      <span class="navbar-toggler-icon"></span>
    </button>
    <div class="collapse navbar-collapse justify-content-end" id="navbarNav">
      <ul class="navbar-nav align-items-center">
        <li class="nav-item me-3">
          <a class="nav-link" href="#">Início</a>
        </li>
        <li class="nav-item me-3">
          <a class="nav-link" href="#">Contato</a>
        </li>
        <!-- Ícone do Carrinho -->
        <li class="nav-item">
          <a class="nav-link cart-icon" href="#" data-bs-toggle="modal" data-bs-target="#cartModal">
            <img src="https://img.icons8.com/ios-filled/24/000000/shopping-cart.png" alt="Carrinho">
            <span id="cartCount" class="cart-count">0</span>
          </a>
        </li>
      </ul>
    </div>
  </div>
</nav>

<!-- Banner -->
<div class="container mt-3">
  <div class="banner position-relative">
    <div class="banner-overlay"></div>
    <div class="banner-text">Bem-vindo à Bento Mineiro!</div>
  </div>
</div>

<!-- Categorias (chips) -->
<div class="container">
  <div class="category-chips" id="categoryChips">
    <!-- Chips gerados dinamicamente -->
  </div>
</div>

<!-- Indicador de Carregamento -->
<div id="loadingIndicator">
  <div class="spinner-border" role="status">
    <span class="visually-hidden">Carregando...</span>
  </div>
  <p>Carregando produtos...</p>
</div>

<!-- Lista de Produtos -->
<div class="container">
  <div class="row" id="productContainer">
    <!-- Cards de produto gerados dinamicamente -->
  </div>
</div>

<!-- Modal do Carrinho -->
<div class="modal fade" id="cartModal" tabindex="-1" aria-labelledby="cartModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-dialog-scrollable">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="cartModalLabel">Carrinho</h5>
        <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Fechar"></button>
      </div>
      <div class="modal-body">
        <div id="cartItems"></div>
        <hr>
        <div class="d-flex justify-content-between">
          <strong>Total:</strong>
          <span id="cartTotal">R$ 0,00</span>
        </div>
      </div>
      <div class="modal-footer">
        <button class="btn btn-success" onclick="finalizarPedido()">Finalizar Pedido</button>
      </div>
    </div>
  </div>
</div>

<!-- Footer simples (opcional) -->
<footer class="mt-4 p-3 text-center text-secondary">
  <small>&copy; 2025 Bento Mineiro. Todos os direitos reservados.</small>
</footer>

<!-- Bootstrap JS (Bundle com Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
/* ============================================
   CONFIGURAÇÕES E VARIÁVEIS GLOBAIS
============================================ */
const API_BASE_URL = "https://script.google.com/macros/s/AKfycbzoRWay1-1W0C5weOZcISg1AfYPJ8SHtfrOoZhoxIrbZDC3MrrsIIyRnrnHjqdyKc8u/exec"; // Substitua pela sua URL
const CACHE_KEY = "bentoMineiroProdutos";
const CACHE_TIMESTAMP_KEY = "bentoMineiroProdutosTimestamp";
const CACHE_EXPIRATION = 10 * 60 * 1000; // 10 minutos

// Armazena os dados de produtos e o carrinho
let allProducts = []; // Array de todos os produtos (carregado via API)
let cart = {};        // Objeto cart[productID] = { produto, quantidade }

/* ============================================
   FUNÇÕES DE CACHE E BUSCA DE PRODUTOS
============================================ */
async function fetchProdutosCache() {
  const cachedData = localStorage.getItem(CACHE_KEY);
  const cachedTimestamp = localStorage.getItem(CACHE_TIMESTAMP_KEY);
  const now = Date.now();
  if (cachedData && cachedTimestamp && (now - cachedTimestamp < CACHE_EXPIRATION)) {
    return JSON.parse(cachedData);
  } else {
    const response = await fetch(API_BASE_URL + "?type=produtos");
    const produtos = await response.json();
    localStorage.setItem(CACHE_KEY, JSON.stringify(produtos));
    localStorage.setItem(CACHE_TIMESTAMP_KEY, now);
    return produtos;
  }
}

/* ============================================
   INICIALIZAÇÃO E CARREGAMENTO INICIAL
============================================ */
document.addEventListener("DOMContentLoaded", async () => {
  // Exibe indicador de carregamento
  document.getElementById("loadingIndicator").style.display = "block";
  try {
    allProducts = await fetchProdutosCache();
    gerarChipsDeCategoria(allProducts);
    exibirProdutos(allProducts); // Exibe todos inicialmente ou exibe a 1ª categoria
  } catch (error) {
    console.error("Erro ao carregar produtos:", error);
  } finally {
    document.getElementById("loadingIndicator").style.display = "none";
  }
});

/* ============================================
   FUNÇÕES DE CATEGORIA
============================================ */
function gerarChipsDeCategoria(produtos) {
  const categoryChipsDiv = document.getElementById("categoryChips");
  categoryChipsDiv.innerHTML = "";
  // Extrai as categorias únicas
  const categorias = [...new Set(produtos.map(p => p.Categoria))];
  categorias.forEach(cat => {
    const chip = document.createElement("div");
    chip.className = "category-chip";
    chip.textContent = cat;
    chip.addEventListener("click", () => {
      // Ao clicar, filtra os produtos por esta categoria
      const filtrados = allProducts.filter(p => p.Categoria === cat);
      exibirProdutos(filtrados);
    });
    categoryChipsDiv.appendChild(chip);
  });
}

/* ============================================
   FUNÇÕES PARA EXIBIR PRODUTOS (CARDS)
============================================ */
function exibirProdutos(produtos) {
  const container = document.getElementById("productContainer");
  container.innerHTML = "";
  // Exibe cada produto em um card
  produtos.forEach(prod => {
    const col = document.createElement("div");
    col.className = "col-6 col-md-4 col-lg-3";
    col.innerHTML = `
      <div class="card product-card">
        <img src="${prod.Imagem}" alt="${prod.Nome}">
        <div class="product-body">
          <div class="product-title">${prod.Nome}</div>
          <div class="product-price">R$ ${parseFloat(prod.Valor).toFixed(2)}</div>
          <div class="product-description">${prod.Descricao || ""}</div>
          <button class="btn-add" data-id="${prod.ID}">Adicionar</button>
        </div>
      </div>
    `;
    container.appendChild(col);
  });
  // Adiciona evento de clique no botão "Adicionar"
  const addButtons = container.querySelectorAll(".btn-add");
  addButtons.forEach(btn => {
    btn.addEventListener("click", () => {
      const productID = btn.getAttribute("data-id");
      adicionarAoCarrinho(productID);
    });
  });
}

/* ============================================
   FUNÇÕES DE CARRINHO
============================================ */
function adicionarAoCarrinho(productID) {
  // Busca o produto no array allProducts
  const produto = allProducts.find(p => p.ID == productID);
  if (!produto) return;
  // Incrementa a quantidade
  if (!cart[productID]) {
    cart[productID] = { produto, quantidade: 0 };
  }
  cart[productID].quantidade += 1;
  atualizarContadorCarrinho();
  console.log("Carrinho:", cart);
}

function atualizarContadorCarrinho() {
  const cartCountSpan = document.getElementById("cartCount");
  let totalItens = 0;
  for (const pid in cart) {
    totalItens += cart[pid].quantidade;
  }
  cartCountSpan.textContent = totalItens;
}

function exibirCarrinhoModal() {
  const cartItemsDiv = document.getElementById("cartItems");
  const cartTotalSpan = document.getElementById("cartTotal");
  cartItemsDiv.innerHTML = "";
  let total = 0;
  for (const pid in cart) {
    const item = cart[pid];
    if (item.quantidade > 0) {
      const linha = document.createElement("div");
      linha.className = "cart-item";
      linha.innerHTML = `
        <span>${item.produto.Nome} (x${item.quantidade})</span>
        <strong>R$ ${(parseFloat(item.produto.Valor) * item.quantidade).toFixed(2)}</strong>
      `;
      cartItemsDiv.appendChild(linha);
      total += parseFloat(item.produto.Valor) * item.quantidade;
    }
  }
  cartTotalSpan.textContent = "R$ " + total.toFixed(2);
}

function finalizarPedido() {
  // Integre com seu fluxo de pedido (etapas, API, etc.)
  alert("Fluxo de finalização de pedido aqui...");
}

/* ============================================
   EVENTOS ADICIONAIS
============================================ */
// Abre o modal do carrinho e exibe os itens
document.getElementById("cartModal").addEventListener("show.bs.modal", exibirCarrinhoModal);

// Fecha a navbar em mobile ao clicar em algo
function collapseNavbar() {
  const navbar = document.getElementById("navbarNav");
  const bsCollapse = new bootstrap.Collapse(navbar, {toggle:false});
  bsCollapse.hide();
}

</script>
</body>
</html>