<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel Administrativo - Bento Mineiro</title>
  <!-- Evita indexação -->
  <meta name="robots" content="noindex">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Inputmask para formatação -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.8/inputmask.min.js"></script>
  <style>
    body {
      background-color: #f7f7f7;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    } 
    /* Centralização das seções */
    #loginSection, #adminSection {
      max-width: 900px;
      margin: 0 auto;
    }
    #adminSection {
      display: none;
    }
    .nav-tabs .nav-link {
      cursor: pointer;
    }
    .btn {
      margin-top: 5px;
    }
    /* Estilo básico para formulários */
    input, textarea, select {
      margin-bottom: 10px;
    }
  </style>
</head>
<body>
  <!-- Seção de Login -->
  <div id="loginSection">
    <h2 class="text-center mb-4">Painel Administrativo</h2>
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Faça o Login</h4>
        <div class="mb-3">
          <label for="loginInput" class="form-label">Login:</label>
          <input type="text" id="loginInput" class="form-control" placeholder="Digite o login">
        </div>
        <div class="mb-3">
          <label for="senhaInput" class="form-label">Senha:</label>
          <input type="password" id="senhaInput" class="form-control" placeholder="Digite a senha">
        </div>
        <button class="btn btn-primary" onclick="validarAdmin()">Entrar</button>
      </div>
    </div>
  </div>

  <!-- Seção Administrativa -->
  <div id="adminSection">
    <!-- Navbar interna do painel -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
      <div class="container">
        <span class="navbar-brand">Painel Admin</span>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#produtosTab" role="tab">Produtos</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#categoriasTab" role="tab">Categorias</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#editarTab" role="tab">Editar Produtos</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#planilhaTab" role="tab">Planilha de Pedidos</a></li>
          </ul>
          <button class="btn btn-danger" onclick="sairAdmin()">Sair</button>
        </div>
      </div>
    </nav>
    <div class="tab-content" id="adminTabContent">
      <!-- Aba Produtos -->
      <div class="tab-pane fade show active" id="produtosTab" role="tabpanel">
        <h4>Produtos</h4>
        <div id="listaProdutos"></div>
        <hr>
        <h5>Cadastrar Novo Produto</h5>
        <form id="formProduto">
          <div class="mb-3">
            <label for="produtoNome" class="form-label">Nome:</label>
            <input type="text" id="produtoNome" class="form-control" placeholder="Nome do produto" required>
          </div>
          <div class="mb-3">
            <label for="produtoValor" class="form-label">Valor (R$):</label>
            <input type="text" id="produtoValor" class="form-control" placeholder="Valor" required>
          </div>
          <div class="mb-3">
            <label for="produtoImagem" class="form-label">URL da Imagem:</label>
            <input type="url" id="produtoImagem" class="form-control" placeholder="Link da imagem" required oninput="atualizarPreviewProduto()">
          </div>
          <img id="produtoPreview" src="" alt="Prévia da Imagem">
          <div class="mb-3">
            <label for="produtoCategoria" class="form-label">Categoria:</label>
            <select id="produtoCategoria" class="form-select" required>
              <option value="">Selecione...</option>
              <!-- Será preenchido dinamicamente -->
            </select>
          </div>
          <button type="submit" class="btn btn-success">Cadastrar Produto</button>
        </form>
      </div>
      <!-- Aba Categorias -->
      <div class="tab-pane fade" id="categoriasTab" role="tabpanel">
        <h4>Categorias</h4>
        <div id="listaCategorias"></div>
        <hr>
        <h5>Cadastrar Nova Categoria</h5>
        <form id="formCategoria">
          <div class="mb-3">
            <label for="categoriaNome" class="form-label">Nome:</label>
            <input type="text" id="categoriaNome" class="form-control" placeholder="Nome da categoria" required>
          </div>
          <div class="mb-3">
            <label for="categoriaImagem" class="form-label">URL da Imagem:</label>
            <input type="url" id="categoriaImagem" class="form-control" placeholder="Link da imagem" required>
          </div>
          <button type="submit" class="btn btn-success">Cadastrar Categoria</button>
        </form>
      </div>
      <!-- Aba Editar Produtos -->
      <div class="tab-pane fade" id="editarTab" role="tabpanel">
        <h4>Editar Produtos</h4>
        <div id="listaProdutosEditar"></div>
        <hr>
        <h5>Editar Produto</h5>
        <form id="formEditarProduto">
          <div class="mb-3">
            <label for="editarProdutoSelect" class="form-label">Selecione o Produto:</label>
            <select id="editarProdutoSelect" class="form-select" required>
              <option value="">Selecione...</option>
              <!-- Será preenchido dinamicamente -->
            </select>
          </div>
          <div class="mb-3">
            <label for="editarProdutoNome" class="form-label">Nome:</label>
            <input type="text" id="editarProdutoNome" class="form-control" placeholder="Nome do produto" required>
          </div>
          <div class="mb-3">
            <label for="editarProdutoValor" class="form-label">Valor (R$):</label>
            <input type="text" id="editarProdutoValor" class="form-control" placeholder="Valor" required>
          </div>
          <div class="mb-3">
            <label for="editarProdutoImagem" class="form-label">URL da Imagem:</label>
            <input type="url" id="editarProdutoImagem" class="form-control" placeholder="Link da imagem" required oninput="atualizarPreviewEditar()">
          </div>
          <img id="editarProdutoPreview" src="" alt="Prévia da Imagem">
          <div class="mb-3">
            <label for="editarProdutoCategoria" class="form-label">Categoria:</label>
            <select id="editarProdutoCategoria" class="form-select" required>
              <option value="">Selecione...</option>
              <!-- Será preenchido dinamicamente -->
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        </form>
      </div>
      <!-- Aba Planilha de Pedidos -->
      <div class="tab-pane fade" id="planilhaTab" role="tabpanel">
        <h4>Planilha de Pedidos</h4>
        <p>Clique no botão abaixo para acessar a planilha de pedidos:</p>
        <a href="https://docs.google.com/spreadsheets/d/19Va_8hH83EjT-vyUGt_uCQgB6aITo_BHSkVWeMt8bc8/edit?usp=sharing" target="_blank" class="btn btn-info">Abrir Planilha</a>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS (Bundle com Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  
  <!-- Firebase SDK (versão modular) -->
  <script type="module">
    // Importa as funções necessárias do Firebase
    import { initializeApp } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-app.js";
    import { getFirestore, collection, getDocs, addDoc, updateDoc, deleteDoc, doc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
    
    // Sua configuração do Firebase
    const firebaseConfig = {
      apiKey: "AIzaSyDTlM2n4Cg-x1vv-LNNMY-6Pl5UCHLpUko",
      authDomain: "bento-mineiro.firebaseapp.com",
      projectId: "bento-mineiro",
      storageBucket: "bento-mineiro.firebasestorage.app",
      messagingSenderId: "806545810961",
      appId: "1:806545810961:web:9a7356991a13581d7f33b0",
      measurementId: "G-5GGXJS06RW"
    };
    
    // Inicializa o Firebase e o Firestore
    const app = initializeApp(firebaseConfig);
    const db = getFirestore(app);
    
    // Credenciais fixas para o admin (login simples)
    const ADMIN_LOGIN = "BentoMineiro";
    const ADMIN_SENHA = "SantoBento2025";
    
    // Função de login
    function validarAdmin() {
      const login = document.getElementById("loginInput").value;
      const senha = document.getElementById("senhaInput").value;
      if (login === ADMIN_LOGIN && senha === ADMIN_SENHA) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("adminSection").style.display = "block";
        carregarCategoriasNoSelect();
        carregarListaProdutos();
        carregarListaCategorias();
        carregarProdutosMigracao();
        carregarProdutosEditar();
      } else {
        alert("Login ou senha incorretos.");
      }
    }
    
    function sairAdmin() {
      if (confirm("Deseja realmente sair?")) {
        window.location.reload();
      }
    }
    
    // FUNÇÕES DE FIRESTORE PARA PRODUTOS
    
    // Carrega a lista de produtos da coleção "produtos"
    async function carregarListaProdutos() {
      const container = document.getElementById("listaProdutos");
      container.innerHTML = "";
      try {
        const querySnapshot = await getDocs(collection(db, "produtos"));
        if (querySnapshot.empty) {
          container.innerHTML = "<p>Nenhum produto cadastrado.</p>";
          return;
        }
        querySnapshot.forEach((docSnap) => {
          const produto = docSnap.data();
          produto.id = docSnap.id;
          const div = document.createElement("div");
          div.className = "card mb-2";
          div.innerHTML = `
            <div class="card-body">
              <h5 class="card-title">${produto.nome}</h5>
              <p class="card-text">Valor: R$ ${produto.valor.toFixed(2)}<br>
              Categoria: ${produto.categoria}</p>
              <p class="card-text">Imagem: <a href="${produto.imagem}" target="_blank">Ver Imagem</a></p>
              <button class="btn btn-sm btn-secondary" onclick="iniciarEdicaoProduto('${produto.id}')">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="excluirProduto('${produto.id}')">Excluir</button>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (error) {
        console.error("Erro ao carregar produtos:", error);
        container.innerHTML = "<p>Erro ao carregar produtos.</p>";
      }
    }
    
    // Cadastra um novo produto na coleção "produtos"
    document.getElementById("formProduto").addEventListener("submit", async function(e) {
      e.preventDefault();
      const produto = {
        nome: document.getElementById("produtoNome").value,
        valor: parseFloat(document.getElementById("produtoValor").value),
        imagem: document.getElementById("produtoImagem").value,
        categoria: document.getElementById("produtoCategoria").value
      };
      try {
        await addDoc(collection(db, "produtos"), produto);
        alert("Produto cadastrado com sucesso!");
        this.reset();
        document.getElementById("produtoPreview").style.display = "none";
        carregarListaProdutos();
        carregarProdutosMigracao();
        carregarProdutosEditar();
      } catch (error) {
        console.error("Erro ao cadastrar produto:", error);
        alert("Erro ao cadastrar produto.");
      }
    });
    
    // Inicia a edição de um produto na aba Editar Produtos (preenche os campos do formulário de edição)
    async function iniciarEdicaoProduto(id) {
      try {
        const docRef = doc(db, "produtos", id);
        const docSnap = await getDocs(docRef); // ou getDoc(docRef)
        // Como getDoc é mais indicado para um único documento:
        import { getDoc } from "https://www.gstatic.com/firebasejs/11.2.0/firebase-firestore.js";
        const docData = await getDoc(docRef);
        if (docData.exists()) {
          const produto = docData.data();
          produto.id = docData.id;
          document.getElementById("editarProdutoSelect").value = produto.id;
          document.getElementById("editarProdutoNome").value = produto.nome;
          document.getElementById("editarProdutoValor").value = produto.valor;
          document.getElementById("editarProdutoImagem").value = produto.imagem;
          document.getElementById("editarProdutoCategoria").value = produto.categoria;
          const preview = document.getElementById("editarProdutoPreview");
          preview.src = produto.imagem;
          preview.style.display = "block";
          // Troque de aba para edição
          const triggerTabList = [].slice.call(document.querySelectorAll('#adminTab a'))
          triggerTabList.forEach(function (triggerEl) {
            let tabTrigger = new bootstrap.Tab(triggerEl)
            if (triggerEl.getAttribute("data-bs-target") === "#editarTab") {
              tabTrigger.show();
            }
          });
        } else {
          alert("Produto não encontrado.");
        }
      } catch (error) {
        console.error("Erro ao iniciar edição do produto:", error);
      }
    }
    
    // Atualiza um produto na coleção "produtos"
    document.getElementById("formEditarProduto").addEventListener("submit", async function(e) {
      e.preventDefault();
      const id = document.getElementById("editarProdutoSelect").value;
      if (!id) {
        alert("Selecione um produto para editar.");
        return;
      }
      const novosDados = {
        nome: document.getElementById("editarProdutoNome").value,
        valor: parseFloat(document.getElementById("editarProdutoValor").value),
        imagem: document.getElementById("editarProdutoImagem").value,
        categoria: document.getElementById("editarProdutoCategoria").value
      };
      try {
        await updateDoc(doc(db, "produtos", id), novosDados);
        alert("Produto atualizado com sucesso!");
        this.reset();
        document.getElementById("editarProdutoPreview").style.display = "none";
        carregarListaProdutos();
        carregarProdutosMigracao();
        carregarProdutosEditar();
      } catch (error) {
        console.error("Erro ao atualizar produto:", error);
        alert("Erro ao atualizar produto.");
      }
    });
    
    // Exclui um produto
    async function excluirProduto(id) {
      if (confirm("Deseja realmente excluir este produto?")) {
        try {
          await deleteDoc(doc(db, "produtos", id));
          alert("Produto excluído com sucesso!");
          carregarListaProdutos();
          carregarProdutosMigracao();
          carregarProdutosEditar();
        } catch (error) {
          console.error("Erro ao excluir produto:", error);
          alert("Erro ao excluir produto.");
        }
      }
    }
    
    // FUNÇÕES DE FIRESTORE PARA CATEGORIAS
    
    // Carrega a lista de categorias da coleção "categorias"
    async function carregarListaCategorias() {
      const container = document.getElementById("listaCategorias");
      container.innerHTML = "";
      try {
        const querySnapshot = await getDocs(collection(db, "categorias"));
        if (querySnapshot.empty) {
          container.innerHTML = "<p>Nenhuma categoria cadastrada.</p>";
          return;
        }
        querySnapshot.forEach((docSnap) => {
          const categoria = docSnap.data();
          categoria.id = docSnap.id;
          const div = document.createElement("div");
          div.className = "card mb-2";
          div.innerHTML = `
            <div class="card-body">
              <h5 class="card-title">${categoria.nome}</h5>
              <p class="card-text">Imagem: <a href="${categoria.imagem}" target="_blank">Ver Imagem</a></p>
              <button class="btn btn-sm btn-secondary" onclick="editarCategoria('${categoria.id}')">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="excluirCategoria('${categoria.id}')">Excluir</button>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (error) {
        console.error("Erro ao carregar categorias:", error);
        container.innerHTML = "<p>Erro ao carregar categorias.</p>";
      }
    }
    
    // Cadastra uma nova categoria
    document.getElementById("formCategoria").addEventListener("submit", async function(e) {
      e.preventDefault();
      const categoria = {
        nome: document.getElementById("categoriaNome").value,
        imagem: document.getElementById("categoriaImagem").value
      };
      try {
        await addDoc(collection(db, "categorias"), categoria);
        alert("Categoria cadastrada com sucesso!");
        this.reset();
        carregarListaCategorias();
        carregarCategoriasNoSelect();
        carregarProdutosMigracao();
        carregarProdutosEditar();
      } catch (error) {
        console.error("Erro ao cadastrar categoria:", error);
        alert("Erro ao cadastrar categoria.");
      }
    });
    
    // Preenche o select de categorias para os formulários de produto e edição
    async function carregarCategoriasNoSelect() {
      const selectProduto = document.getElementById("produtoCategoria");
      const selectEditar = document.getElementById("editarProdutoCategoria");
      selectProduto.innerHTML = '<option value="">Selecione...</option>';
      selectEditar.innerHTML = '<option value="">Selecione...</option>';
      try {
        const querySnapshot = await getDocs(collection(db, "categorias"));
        querySnapshot.forEach((docSnap) => {
          const categoria = docSnap.data();
          const option1 = document.createElement("option");
          option1.value = categoria.nome;
          option1.innerText = categoria.nome;
          selectProduto.appendChild(option1);
          const option2 = document.createElement("option");
          option2.value = categoria.nome;
          option2.innerText = categoria.nome;
          selectEditar.appendChild(option2);
        });
      } catch (error) {
        console.error("Erro ao carregar categorias para selects:", error);
      }
    }
    
    // Edita uma categoria (preenche o formulário para edição)
    async function editarCategoria(id) {
      try {
        const docSnap = await getDoc(doc(db, "categorias", id));
        if (docSnap.exists()) {
          const categoria = docSnap.data();
          document.getElementById("categoriaNome").value = categoria.nome;
          document.getElementById("categoriaImagem").value = categoria.imagem;
          // Exclui a categoria atual para que a nova submissão seja tratada como edição
          await deleteDoc(doc(db, "categorias", id));
          alert("Edite os campos e cadastre a categoria novamente para concluir a edição.");
          carregarListaCategorias();
          carregarCategoriasNoSelect();
          carregarProdutosMigracao();
          carregarProdutosEditar();
        }
      } catch (error) {
        console.error("Erro ao editar categoria:", error);
      }
    }
    
    // Exclui uma categoria
    async function excluirCategoria(id) {
      if (confirm("Deseja realmente excluir esta categoria?")) {
        try {
          await deleteDoc(doc(db, "categorias", id));
          alert("Categoria excluída com sucesso!");
          carregarListaCategorias();
          carregarCategoriasNoSelect();
          carregarProdutosMigracao();
          carregarProdutosEditar();
        } catch (error) {
          console.error("Erro ao excluir categoria:", error);
          alert("Erro ao excluir categoria.");
        }
      }
    }
    
    // Aba "Editar Produtos": Carrega os produtos para o dropdown e a lista de produtos
    async function carregarProdutosMigracao() {
      const select = document.getElementById("editarProdutoSelect");
      select.innerHTML = '<option value="">Selecione...</option>';
      try {
        const querySnapshot = await getDocs(collection(db, "produtos"));
        querySnapshot.forEach((docSnap) => {
          const produto = docSnap.data();
          produto.id = docSnap.id;
          const option = document.createElement("option");
          option.value = produto.id;
          option.innerText = produto.nome + " (" + produto.categoria + ")";
          select.appendChild(option);
        });
      } catch (error) {
        console.error("Erro ao carregar produtos para edição:", error);
      }
    }
    
    async function carregarProdutosEditar() {
      const container = document.getElementById("listaProdutosEditar");
      container.innerHTML = "";
      try {
        const querySnapshot = await getDocs(collection(db, "produtos"));
        if (querySnapshot.empty) {
          container.innerHTML = "<p>Nenhum produto cadastrado.</p>";
          return;
        }
        querySnapshot.forEach((docSnap) => {
          const produto = docSnap.data();
          produto.id = docSnap.id;
          const div = document.createElement("div");
          div.className = "card mb-2";
          div.innerHTML = `
            <div class="card-body">
              <h5 class="card-title">${produto.nome}</h5>
              <p class="card-text">Valor: R$ ${produto.valor.toFixed(2)}<br>
              Categoria: ${produto.categoria}</p>
              <p class="card-text">Imagem: <a href="${produto.imagem}" target="_blank">Ver Imagem</a></p>
            </div>
          `;
          container.appendChild(div);
        });
        carregarProdutosMigracao();
      } catch (error) {
        console.error("Erro ao carregar produtos para edição:", error);
        container.innerHTML = "<p>Erro ao carregar produtos.</p>";
      }
    }
    
    // Função para atualizar a prévia da imagem no formulário de edição
    function atualizarPreviewEditar() {
      const url = document.getElementById("editarProdutoImagem").value;
      const preview = document.getElementById("editarProdutoPreview");
      if (url) {
        preview.src = url;
        preview.style.display = "block";
      } else {
        preview.style.display = "none";
      }
    }
    
    // Aplica Inputmask para formatação de valor (moeda)
    window.addEventListener("load", () => {
      Inputmask({"alias": "currency", "prefix": "R$ "}).mask(document.getElementById("produtoValor"));
      Inputmask({"alias": "currency", "prefix": "R$ "}).mask(document.getElementById("editarProdutoValor"));
    });
    
    // Função para limpar o pedido (aqui não interfere no banco, pois é para uso do site público)
    function limparPedido() {
      if (confirm("Tem certeza que deseja limpar o pedido?")) {
        // Se necessário, você pode implementar uma função para limpar dados no site público
        alert("Função 'limpar pedido' é exclusiva do site público.");
      }
    }
    
  </script>
</body>
</html>