<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <title>Painel Administrativo - Bento Mineiro</title>
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <!-- Bootstrap CSS e Google Fonts -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;600&display=swap" rel="stylesheet">
  <style>
    body {
      font-family: 'Poppins', sans-serif;
      background-color: #f7f7f7;
      padding: 20px;
    }
    h2 {
      margin-top: 20px;
      margin-bottom: 20px;
    }
    .form-section {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .list-section {
      background: #fff;
      padding: 15px;
      border-radius: 8px;
      box-shadow: 0 2px 5px rgba(0,0,0,0.1);
      margin-bottom: 20px;
    }
    .btn-space {
      margin-right: 10px;
    }
  </style>
</head>
<body>

<div class="container">
  <h2 class="text-center">Painel Administrativo - Bento Mineiro</h2>
  
  <!-- Seção de Produtos -->
  <div class="form-section">
    <h3>Incluir Produto</h3>
    <form id="formIncluirProduto">
      <div class="mb-3">
        <label for="prodNome" class="form-label">Nome</label>
        <input type="text" class="form-control" id="prodNome" required>
      </div>
      <div class="mb-3">
        <label for="prodValor" class="form-label">Valor (R$)</label>
        <input type="number" step="0.01" class="form-control" id="prodValor" required>
      </div>
      <div class="mb-3">
        <label for="prodImagem" class="form-label">URL da Imagem</label>
        <input type="url" class="form-control" id="prodImagem" required>
      </div>
      <div class="mb-3">
        <label for="prodCategoria" class="form-label">Categoria</label>
        <input type="text" class="form-control" id="prodCategoria" placeholder="Ex: Pronta Entrega" required>
      </div>
      <div class="mb-3">
        <label for="prodTipo" class="form-label">Tipo</label>
        <select class="form-select" id="prodTipo" required>
          <option value="Pronta Entrega">Pronta Entrega</option>
          <option value="Encomenda">Encomenda</option>
        </select>
      </div>
      <div class="mb-3">
        <label for="prodDescricao" class="form-label">Descrição (Opcional)</label>
        <textarea class="form-control" id="prodDescricao" rows="3"></textarea>
      </div>
      <button type="submit" class="btn btn-success btn-space">Incluir Produto</button>
    </form>
  </div>

  <!-- Seção de Edição de Produto -->
  <div class="list-section">
    <h3>Editar/Excluir Produto</h3>
    <div id="listaProdutosAdmin"></div>
  </div>

  <!-- Seção de Categorias -->
  <div class="form-section">
    <h3>Incluir Categoria</h3>
    <form id="formIncluirCategoria">
      <div class="mb-3">
        <label for="catNome" class="form-label">Nome da Categoria</label>
        <input type="text" class="form-control" id="catNome" required>
      </div>
      <button type="submit" class="btn btn-success btn-space">Incluir Categoria</button>
    </form>
  </div>
  <div class="list-section">
    <h3>Editar/Excluir Categoria</h3>
    <div id="listaCategoriasAdmin"></div>
  </div>
</div>

<!-- Bootstrap JS (Bundle com Popper) -->
<script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
<script>
  /* ==============================================
     CONFIGURAÇÕES GLOBAIS
  ============================================= */
  // URL da API do Google Apps Script (seu Web App)
  const API_BASE_URL = "https://script.google.com/macros/s/AKfycbzoRWay1-1W0C5weOZcISg1AfYPJ8SHtfrOoZhoxIrbZDC3MrrsIIyRnrnHjqdyKc8u/exec";
  
  // Função para fazer requisição GET
  async function apiGet(type, id = "") {
    let url = API_BASE_URL + "?type=" + type;
    if (id) url += "&id=" + id;
    const response = await fetch(url);
    return await response.json();
  }
  
  // Função para fazer requisição POST
  async function apiPost(type, data) {
    const url = API_BASE_URL + "?type=" + type;
    const response = await fetch(url, {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    return await response.json();
  }
  
  // Função para fazer requisição PUT (atualização)
  async function apiPut(type, data) {
    const url = API_BASE_URL + "?type=" + type;
    const response = await fetch(url, {
      method: "PUT",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify(data)
    });
    return await response.json();
  }
  
  // Função para fazer requisição DELETE
  async function apiDelete(type, id) {
    const url = API_BASE_URL + "?type=" + type + "&id=" + id;
    const response = await fetch(url, { method: "DELETE" });
    return await response.json();
  }
  
  /* ==============================================
     FUNÇÕES PARA PRODUTOS
  ============================================= */
  async function carregarProdutosAdmin() {
    try {
      const produtos = await apiGet("produtos");
      renderizarListaProdutos(produtos);
    } catch (error) {
      console.error("Erro ao carregar produtos:", error);
    }
  }
  
  function renderizarListaProdutos(produtos) {
    const container = document.getElementById("listaProdutosAdmin");
    container.innerHTML = "";
    if (!produtos || produtos.length === 0) {
      container.innerHTML = "<p>Nenhum produto cadastrado.</p>";
      return;
    }
    produtos.forEach(prod => {
      const div = document.createElement("div");
      div.className = "d-flex justify-content-between align-items-center border-bottom py-2";
      div.innerHTML = `
        <div>
          <strong>${prod.Nome}</strong> - R$ ${parseFloat(prod.Valor).toFixed(2)}<br>
          Categoria: ${prod.Categoria} | Tipo: ${prod.Tipo || ""}<br>
          ${prod.Descricao ? prod.Descricao : ""}
        </div>
        <div>
          <button class="btn btn-sm btn-primary me-1" onclick="editarProduto('${prod.ID}')">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="excluirProduto('${prod.ID}')">Excluir</button>
        </div>
      `;
      container.appendChild(div);
    });
  }
  
  async function incluirProduto(event) {
    event.preventDefault();
    const produto = {
      Nome: document.getElementById("prodNome").value,
      Valor: parseFloat(document.getElementById("prodValor").value),
      Imagem: document.getElementById("prodImagem").value,
      Categoria: document.getElementById("prodCategoria").value,
      Tipo: document.getElementById("prodTipo").value,
      Descricao: document.getElementById("prodDescricao").value
    };
    try {
      const result = await apiPost("produto", produto);
      if (result.result === "success") {
        alert("Produto incluído com sucesso!");
        document.getElementById("formIncluirProduto").reset();
        carregarProdutosAdmin();
      } else {
        alert("Erro ao incluir produto: " + result.error);
      }
    } catch (error) {
      console.error("Erro:", error);
    }
  }
  
  async function editarProduto(id) {
    // Carrega dados do produto e preenche o formulário de inclusão (pode criar um modal separado para edição)
    try {
      const produto = await apiGet("produto", id);
      if (produto.result && produto.error) {
        alert("Produto não encontrado.");
        return;
      }
      // Preenche o formulário com os dados atuais
      document.getElementById("prodNome").value = produto.Nome;
      document.getElementById("prodValor").value = produto.Valor;
      document.getElementById("prodImagem").value = produto.Imagem;
      document.getElementById("prodCategoria").value = produto.Categoria;
      document.getElementById("prodTipo").value = produto.Tipo || "Pronta Entrega";
      document.getElementById("prodDescricao").value = produto.Descricao || "";
      // Altera o comportamento do formulário para editar
      document.getElementById("formIncluirProduto").onsubmit = async function(e) {
        e.preventDefault();
        const produtoAtualizado = {
          id: id,
          Nome: document.getElementById("prodNome").value,
          Valor: parseFloat(document.getElementById("prodValor").value),
          Imagem: document.getElementById("prodImagem").value,
          Categoria: document.getElementById("prodCategoria").value,
          Tipo: document.getElementById("prodTipo").value,
          Descricao: document.getElementById("prodDescricao").value
        };
        const res = await apiPut("produto", produtoAtualizado);
        if (res.result === "success") {
          alert("Produto atualizado com sucesso!");
          document.getElementById("formIncluirProduto").reset();
          // Restaura o comportamento do formulário para inclusão
          document.getElementById("formIncluirProduto").onsubmit = incluirProduto;
          carregarProdutosAdmin();
        } else {
          alert("Erro ao atualizar: " + res.error);
        }
      };
    } catch (error) {
      console.error("Erro ao editar produto:", error);
    }
  }
  
  async function excluirProduto(id) {
    if (confirm("Deseja realmente excluir este produto?")) {
      const res = await apiDelete("produto", id);
      if (res.result === "success") {
        alert("Produto excluído com sucesso!");
        carregarProdutosAdmin();
      } else {
        alert("Erro ao excluir produto: " + res.error);
      }
    }
  }
  
  /* ==============================================
     FUNÇÕES PARA CATEGORIAS
  ============================================= */
  async function carregarCategoriasAdmin() {
    try {
      const categorias = await apiGet("categorias");
      renderizarListaCategorias(categorias);
    } catch (error) {
      console.error("Erro ao carregar categorias:", error);
    }
  }
  
  function renderizarListaCategorias(categorias) {
    const container = document.getElementById("listaCategoriasAdmin");
    container.innerHTML = "";
    if (!categorias || categorias.length === 0) {
      container.innerHTML = "<p>Nenhuma categoria cadastrada.</p>";
      return;
    }
    categorias.forEach(cat => {
      const div = document.createElement("div");
      div.className = "d-flex justify-content-between align-items-center border-bottom py-2";
      div.innerHTML = `
        <div><strong>${cat.Nome}</strong></div>
        <div>
          <button class="btn btn-sm btn-primary me-1" onclick="editarCategoria('${cat.ID}', '${cat.Nome}')">Editar</button>
          <button class="btn btn-sm btn-danger" onclick="excluirCategoria('${cat.ID}')">Excluir</button>
        </div>
      `;
      container.appendChild(div);
    });
  }
  
  async function incluirCategoria(event) {
    event.preventDefault();
    const categoria = { Nome: document.getElementById("catNome").value };
    try {
      const res = await apiPost("categoria", categoria);
      if (res.result === "success") {
        alert("Categoria incluída com sucesso!");
        document.getElementById("formIncluirCategoria").reset();
        carregarCategoriasAdmin();
      } else {
        alert("Erro ao incluir categoria: " + res.error);
      }
    } catch (error) {
      console.error("Erro:", error);
    }
  }
  
  async function editarCategoria(id, nomeAtual) {
    const novoNome = prompt("Edite o nome da categoria:", nomeAtual);
    if (novoNome && novoNome.trim() !== "") {
      const categoriaAtualizada = { id: id, Nome: novoNome.trim() };
      const res = await apiPut("categoria", categoriaAtualizada);
      if (res.result === "success") {
        alert("Categoria atualizada com sucesso!");
        carregarCategoriasAdmin();
      } else {
        alert("Erro ao atualizar categoria: " + res.error);
      }
    }
  }
  
  async function excluirCategoria(id) {
    if (confirm("Deseja realmente excluir esta categoria?")) {
      const res = await apiDelete("categoria", id);
      if (res.result === "success") {
        alert("Categoria excluída com sucesso!");
        carregarCategoriasAdmin();
      } else {
        alert("Erro ao excluir categoria: " + res.error);
      }
    }
  }
  
  /* ==============================================
     SALVAR/CARREGAR USER DATA (localStorage)
  ============================================= */
  function salvarUserData() {
    localStorage.setItem("bentoMineiroUserData", JSON.stringify(userData));
  }
  function carregarUserData() {
    const data = localStorage.getItem("bentoMineiroUserData");
    userData = data ? JSON.parse(data) : {};
  }
  
  /* ==============================================
     OUTROS
  ============================================= */
  function mostrarCarregando(status) {
    document.getElementById("loadingIndicator").style.display = status ? "block" : "none";
  }
  
  // Inicializa as listas de produtos e categorias no admin
  window.onload = function() {
    carregarProdutosAdmin();
    carregarCategoriasAdmin();
  };
  
  // Registra os formulários
  document.getElementById("formIncluirProduto").addEventListener("submit", incluirProduto);
  document.getElementById("formIncluirCategoria").addEventListener("submit", incluirCategoria);
  
</script>
</body>
</html>