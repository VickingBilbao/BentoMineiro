<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel Administrativo - Bento Mineiro</title>
  <!-- Evita indexação -->
  <meta name="robots" content="noindex">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Inputmask para formatação de moeda -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.8/inputmask.min.js"></script>
  <style>
    body {
      background-color: #f7f7f7;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    /* Centralização do conteúdo */
    #loginSection, #adminSection {
      max-width: 900px;
      margin: 0 auto;
    }
    #adminSection {
      display: none;
    }
    .nav-tabs .nav-link {
      cursor: pointer;
    }
    .btn {
      margin-top: 5px;
    }
    /* Prévia da imagem do produto */
    #produtoPreview, #editarProdutoPreview {
      max-width: 600px;
      aspect-ratio: 4 / 1;
      object-fit: cover;
      border: 1px solid #ccc;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Seção de Login -->
  <div id="loginSection">
    <h2 class="text-center mb-4">Painel Administrativo</h2>
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Faça o Login</h4>
        <div class="mb-3">
          <label for="loginInput" class="form-label">Login:</label>
          <input type="text" id="loginInput" class="form-control" placeholder="Digite o login">
        </div>
        <div class="mb-3">
          <label for="senhaInput" class="form-label">Senha:</label>
          <input type="password" id="senhaInput" class="form-control" placeholder="Digite a senha">
        </div>
        <button class="btn btn-primary" onclick="validarAdmin()">Entrar</button>
      </div>
    </div>
  </div>

  <!-- Seção Administrativa -->
  <div id="adminSection">
    <!-- Navbar interna do painel -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
      <div class="container">
        <span class="navbar-brand">Painel Admin</span>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#produtosTab" role="tab">Produtos</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#categoriasTab" role="tab">Categorias</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#editarTab" role="tab">Editar Produtos</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#planilhaTab" role="tab">Planilha de Pedidos</a></li>
          </ul>
          <button class="btn btn-danger" onclick="sairAdmin()">Sair</button>
        </div>
      </div>
    </nav>
    <div class="tab-content" id="adminTabContent">
      <!-- Aba Produtos -->
      <div class="tab-pane fade show active" id="produtosTab" role="tabpanel">
        <h4>Produtos</h4>
        <div id="listaProdutos"></div>
        <hr>
        <h5>Cadastrar Novo Produto</h5>
        <form id="formProduto">
          <div class="mb-3">
            <label for="produtoNome" class="form-label">Nome:</label>
            <input type="text" id="produtoNome" class="form-control" placeholder="Nome do produto" required>
          </div>
          <div class="mb-3">
            <label for="produtoValor" class="form-label">Valor (R$):</label>
            <input type="text" id="produtoValor" class="form-control" placeholder="Valor" required>
          </div>
          <div class="mb-3">
            <label for="produtoImagem" class="form-label">URL da Imagem:</label>
            <input type="url" id="produtoImagem" class="form-control" placeholder="Link da imagem" required oninput="atualizarPreviewProduto()">
          </div>
          <img id="produtoPreview" src="" alt="Prévia da Imagem">
          <div class="mb-3 mt-3">
            <label for="produtoCategoria" class="form-label">Categoria:</label>
            <select id="produtoCategoria" class="form-select" required>
              <option value="">Selecione...</option>
              <!-- Preenchido dinamicamente -->
            </select>
          </div>
          <button type="submit" class="btn btn-success">Cadastrar Produto</button>
        </form>
      </div>
      <!-- Aba Categorias -->
      <div class="tab-pane fade" id="categoriasTab" role="tabpanel">
        <h4>Categorias</h4>
        <div id="listaCategorias"></div>
        <hr>
        <h5>Cadastrar Nova Categoria</h5>
        <form id="formCategoria">
          <div class="mb-3">
            <label for="categoriaNome" class="form-label">Nome:</label>
            <input type="text" id="categoriaNome" class="form-control" placeholder="Nome da categoria" required>
          </div>
          <div class="mb-3">
            <label for="categoriaImagem" class="form-label">URL da Imagem:</label>
            <input type="url" id="categoriaImagem" class="form-control" placeholder="Link da imagem" required>
          </div>
          <button type="submit" class="btn btn-success">Cadastrar Categoria</button>
        </form>
      </div>
      <!-- Aba Editar Produtos -->
      <div class="tab-pane fade" id="editarTab" role="tabpanel">
        <h4>Editar Produtos</h4>
        <div id="listaProdutosEditar"></div>
        <hr>
        <h5>Editar Produto</h5>
        <form id="formEditarProduto">
          <div class="mb-3">
            <label for="editarProdutoSelect" class="form-label">Selecione o Produto:</label>
            <select id="editarProdutoSelect" class="form-select" required>
              <option value="">Selecione...</option>
              <!-- Preenchido dinamicamente -->
            </select>
          </div>
          <div class="mb-3">
            <label for="editarProdutoNome" class="form-label">Nome:</label>
            <input type="text" id="editarProdutoNome" class="form-control" placeholder="Nome do produto" required>
          </div>
          <div class="mb-3">
            <label for="editarProdutoValor" class="form-label">Valor (R$):</label>
            <input type="text" id="editarProdutoValor" class="form-control" placeholder="Valor" required>
          </div>
          <div class="mb-3">
            <label for="editarProdutoImagem" class="form-label">URL da Imagem:</label>
            <input type="url" id="editarProdutoImagem" class="form-control" placeholder="Link da imagem" required oninput="atualizarPreviewEditar()">
          </div>
          <img id="editarProdutoPreview" src="" alt="Prévia da Imagem">
          <div class="mb-3">
            <label for="editarProdutoCategoria" class="form-label">Categoria:</label>
            <select id="editarProdutoCategoria" class="form-select" required>
              <option value="">Selecione...</option>
              <!-- Preenchido dinamicamente -->
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        </form>
      </div>
      <!-- Aba Planilha de Pedidos -->
      <div class="tab-pane fade" id="planilhaTab" role="tabpanel">
        <h4>Planilha de Pedidos</h4>
        <p>Clique no botão abaixo para acessar a planilha de pedidos:</p>
        <a href="https://docs.google.com/spreadsheets/d/19Va_8hH83EjT-vyUGt_uCQgB6aITo_BHSkVWeMt8bc8/edit?usp=sharing" target="_blank" class="btn btn-info">Abrir Planilha</a>
      </div>
    </div>
  </div>

  <!-- Bootstrap JS (Bundle com Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script>
    // Credenciais fixas para acesso
    const ADMIN_LOGIN = "BentoMineiro";
    const ADMIN_SENHA = "SantoBento2025";
    
    function validarAdmin() {
      const login = document.getElementById("loginInput").value;
      const senha = document.getElementById("senhaInput").value;
      if (login === ADMIN_LOGIN && senha === ADMIN_SENHA) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("adminSection").style.display = "block";
        inicializarDados();
        carregarListaCategorias();
        carregarCategoriasNoSelect();
        carregarListaProdutos();
        carregarProdutosMigracao();
        carregarProdutosEditar();
      } else {
        alert("Login ou senha incorretos.");
      }
    }
    
    function sairAdmin() {
      if (confirm("Deseja realmente sair?")) {
        window.location.reload();
      }
    }
    
    // Persistência via localStorage (simulação)
    function inicializarDados() {
      if (!localStorage.getItem("admin_produtos")) {
        localStorage.setItem("admin_produtos", JSON.stringify([]));
      }
      if (!localStorage.getItem("admin_categorias")) {
        localStorage.setItem("admin_categorias", JSON.stringify([]));
      }
    }
    function getProdutos() {
      return JSON.parse(localStorage.getItem("admin_produtos"));
    }
    function setProdutos(produtos) {
      localStorage.setItem("admin_produtos", JSON.stringify(produtos));
    }
    function getCategorias() {
      return JSON.parse(localStorage.getItem("admin_categorias"));
    }
    function setCategorias(categorias) {
      localStorage.setItem("admin_categorias", JSON.stringify(categorias));
    }
    
    // Cadastro de novo produto
    document.getElementById("formProduto").addEventListener("submit", function(e) {
      e.preventDefault();
      const produto = {
        id: Date.now(),
        nome: document.getElementById("produtoNome").value,
        valor: parseFloat(document.getElementById("produtoValor").value),
        imagem: document.getElementById("produtoImagem").value,
        categoria: document.getElementById("produtoCategoria").value
      };
      const produtos = getProdutos();
      produtos.push(produto);
      setProdutos(produtos);
      alert("Produto cadastrado com sucesso!");
      this.reset();
      document.getElementById("produtoPreview").style.display = "none";
      carregarListaProdutos();
      carregarProdutosMigracao();
      carregarProdutosEditar();
    });
    
    function atualizarPreviewProduto() {
      const url = document.getElementById("produtoImagem").value;
      const preview = document.getElementById("produtoPreview");
      if (url) {
        preview.src = url;
        preview.style.display = "block";
      } else {
        preview.style.display = "none";
      }
    }
    
    // Cadastro de nova categoria
    document.getElementById("formCategoria").addEventListener("submit", function(e) {
      e.preventDefault();
      const categoria = {
        id: Date.now(),
        nome: document.getElementById("categoriaNome").value,
        imagem: document.getElementById("categoriaImagem").value
      };
      const categorias = getCategorias();
      categorias.push(categoria);
      setCategorias(categorias);
      alert("Categoria cadastrada com sucesso!");
      this.reset();
      carregarListaCategorias();
      carregarCategoriasNoSelect();
      carregarProdutosMigracao();
      carregarProdutosEditar();
    });
    
    // Preenche o select de categorias nos formulários de produto e edição
    function carregarCategoriasNoSelect() {
      const categorias = getCategorias();
      const selectProduto = document.getElementById("produtoCategoria");
      const selectEditar = document.getElementById("editarProdutoCategoria");
      selectProduto.innerHTML = '<option value="">Selecione...</option>';
      selectEditar.innerHTML = '<option value="">Selecione...</option>';
      categorias.forEach(c => {
        const option = document.createElement("option");
        option.value = c.nome;
        option.innerText = c.nome;
        selectProduto.appendChild(option);
        const option2 = document.createElement("option");
        option2.value = c.nome;
        option2.innerText = c.nome;
        selectEditar.appendChild(option2);
      });
    }
    
    // Lista de produtos para a aba Produtos
    function carregarListaProdutos() {
      const produtos = getProdutos();
      const container = document.getElementById("listaProdutos");
      container.innerHTML = "";
      if (produtos.length === 0) {
        container.innerHTML = "<p>Nenhum produto cadastrado.</p>";
        return;
      }
      produtos.forEach(produto => {
        const div = document.createElement("div");
        div.className = "card mb-2";
        div.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">${produto.nome}</h5>
            <p class="card-text">Valor: R$ ${produto.valor.toFixed(2)}<br>
            Categoria: ${produto.categoria}</p>
            <p class="card-text">Imagem: <a href="${produto.imagem}" target="_blank">Ver Imagem</a></p>
            <button class="btn btn-sm btn-secondary" onclick="editarProduto(${produto.id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="excluirProduto(${produto.id})">Excluir</button>
          </div>
        `;
        container.appendChild(div);
      });
    }
    
    // Funções para editar e excluir produto (aba Produtos)
    function editarProduto(id) {
      const produtos = getProdutos();
      const produto = produtos.find(p => p.id === id);
      if (!produto) return;
      document.getElementById("produtoNome").value = produto.nome;
      document.getElementById("produtoValor").value = produto.valor;
      document.getElementById("produtoImagem").value = produto.imagem;
      document.getElementById("produtoCategoria").value = produto.categoria;
      atualizarPreviewProduto();
      const novosProdutos = produtos.filter(p => p.id !== id);
      setProdutos(novosProdutos);
      carregarListaProdutos();
      carregarProdutosMigracao();
      carregarProdutosEditar();
    }
    function excluirProduto(id) {
      if (confirm("Deseja realmente excluir este produto?")) {
        const produtos = getProdutos();
        const novosProdutos = produtos.filter(p => p.id !== id);
        setProdutos(novosProdutos);
        carregarListaProdutos();
        carregarProdutosMigracao();
        carregarProdutosEditar();
      }
    }
    
    // Lista de categorias na aba Categorias
    function carregarListaCategorias() {
      const categorias = getCategorias();
      const container = document.getElementById("listaCategorias");
      container.innerHTML = "";
      if (categorias.length === 0) {
        container.innerHTML = "<p>Nenhuma categoria cadastrada.</p>";
        return;
      }
      categorias.forEach(categoria => {
        const div = document.createElement("div");
        div.className = "card mb-2";
        div.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">${categoria.nome}</h5>
            <p class="card-text">Imagem: <a href="${categoria.imagem}" target="_blank">Ver Imagem</a></p>
            <button class="btn btn-sm btn-secondary" onclick="editarCategoria(${categoria.id})">Editar</button>
            <button class="btn btn-sm btn-danger" onclick="excluirCategoria(${categoria.id})">Excluir</button>
          </div>
        `;
        container.appendChild(div);
      });
    }
    function editarCategoria(id) {
      const categorias = getCategorias();
      const categoria = categorias.find(c => c.id === id);
      if (!categoria) return;
      document.getElementById("categoriaNome").value = categoria.nome;
      document.getElementById("categoriaImagem").value = categoria.imagem;
      const novasCategorias = categorias.filter(c => c.id !== id);
      setCategorias(novasCategorias);
      carregarListaCategorias();
      carregarCategoriasNoSelect();
      carregarProdutosMigracao();
      carregarProdutosEditar();
    }
    function excluirCategoria(id) {
      if (confirm("Deseja realmente excluir esta categoria?")) {
        const categorias = getCategorias();
        const novasCategorias = categorias.filter(c => c.id !== id);
        setCategorias(novasCategorias);
        carregarListaCategorias();
        carregarCategoriasNoSelect();
        carregarProdutosMigracao();
        carregarProdutosEditar();
      }
    }
    
    // Preenche o dropdown de produtos para edição na aba Editar Produtos
    function carregarProdutosMigracao() {
      const produtos = getProdutos();
      const select = document.getElementById("editarProdutoSelect");
      select.innerHTML = '<option value="">Selecione...</option>';
      produtos.forEach(p => {
        const op = document.createElement("option");
        op.value = p.id;
        op.innerText = p.nome + " (" + p.categoria + ")";
        select.appendChild(op);
      });
    }
    
    // Preenche a lista de produtos na aba Editar Produtos
    function carregarProdutosEditar() {
      const produtos = getProdutos();
      const container = document.getElementById("listaProdutosEditar");
      container.innerHTML = "";
      if (produtos.length === 0) {
        container.innerHTML = "<p>Nenhum produto cadastrado.</p>";
        return;
      }
      produtos.forEach(produto => {
        const div = document.createElement("div");
        div.className = "card mb-2";
        div.innerHTML = `
          <div class="card-body">
            <h5 class="card-title">${produto.nome}</h5>
            <p class="card-text">Valor: R$ ${produto.valor.toFixed(2)}<br>
            Categoria: ${produto.categoria}</p>
            <p class="card-text">Imagem: <a href="${produto.imagem}" target="_blank">Ver Imagem</a></p>
          </div>
        `;
        container.appendChild(div);
      });
      carregarProdutosMigracao();
    }
    
    // Formulário de edição de produto
    document.getElementById("formEditarProduto").addEventListener("submit", function(e) {
      e.preventDefault();
      const id = parseInt(document.getElementById("editarProdutoSelect").value);
      if (!id) {
        alert("Selecione um produto para editar.");
        return;
      }
      const produtos = getProdutos();
      const index = produtos.findIndex(p => p.id === id);
      if (index === -1) return;
      produtos[index].nome = document.getElementById("editarProdutoNome").value;
      produtos[index].valor = parseFloat(document.getElementById("editarProdutoValor").value);
      produtos[index].imagem = document.getElementById("editarProdutoImagem").value;
      produtos[index].categoria = document.getElementById("editarProdutoCategoria").value;
      setProdutos(produtos);
      alert("Produto atualizado com sucesso!");
      this.reset();
      document.getElementById("editarProdutoPreview").style.display = "none";
      carregarProdutosEditar();
      carregarListaProdutos();
      carregarProdutosMigracao();
    });
    
    // Atualiza a prévia da imagem no formulário de edição
    function atualizarPreviewEditar() {
      const url = document.getElementById("editarProdutoImagem").value;
      const preview = document.getElementById("editarProdutoPreview");
      if (url) {
        preview.src = url;
        preview.style.display = "block";
      } else {
        preview.style.display = "none";
      }
    }
    
    // Formata os campos de valor (moeda) usando Inputmask
    window.addEventListener("load", () => {
      Inputmask({"alias": "currency", "prefix": "R$ "}).mask(document.getElementById("produtoValor"));
      Inputmask({"alias": "currency", "prefix": "R$ "}).mask(document.getElementById("editarProdutoValor"));
    });
    
    // Função para montar o resumo do pedido (para envio via WhatsApp)
    function montarResumo() {
      // Coleta os dados obrigatórios da Etapa 3
      pedido.nome = document.getElementById("nomeDados").value;
      pedido.telefone = document.getElementById("telefoneDados").value;
      pedido.endereco = document.getElementById("enderecoFinal").value;
      pedido.numero = document.getElementById("numero").value;
      pedido.complemento = document.getElementById("complemento").value;
      pedido.observacoes = document.getElementById("observacoes").value;
      
      if (!pedido.nome || !pedido.telefone || !pedido.endereco) {
        alert("Os campos Nome, Telefone e Endereço são obrigatórios.");
        goToStep(3);
        return;
      }
      
      let resumo = "";
      resumo += "*Dados do Cliente:*\n";
      resumo += "*Nome:* " + pedido.nome + "\n";
      resumo += "*Telefone:* " + pedido.telefone + "\n\n";
      
      let totalGeral = 0;
      for (const categoria in pedido.produtos) {
        const quantidades = pedido.produtos[categoria];
        if (quantidades && quantidades.some(q => q > 0)) {
          let catText = "";
          if (categoria === "prontaEntrega") catText = "Pronta Entrega";
          else if (categoria === "encomendas") catText = "Encomendas";
          else if (categoria === "produtosEspeciais") catText = "Produtos Especiais - Queijos Premiados Boníssimo";
          resumo += `*${catText}:*\n`;
          let subtotalCat = 0;
          produtosData[categoria].forEach((produto, index) => {
            const qty = quantidades[index];
            if (qty > 0) {
              const totalProduto = qty * produto.valor;
              resumo += `  - *${produto.nome}*: ${qty} x R$ ${produto.valor.toFixed(2)} = R$ ${totalProduto.toFixed(2)}\n`;
              subtotalCat += totalProduto;
            }
          });
          resumo += `  *Subtotal ${catText}:* R$ ${subtotalCat.toFixed(2)}\n\n`;
          totalGeral += subtotalCat;
        }
      }
      resumo += `*Total Geral:* R$ ${totalGeral.toFixed(2)}\n\n`;
      resumo += `*Observações:* ${pedido.observacoes}\n`;
      resumo += `*Endereço:* ${pedido.endereco}\n`;
      resumo += `*Número:* ${pedido.numero}\n`;
      resumo += `*Complemento:* ${pedido.complemento}\n`;
      
      document.getElementById("resumoPedido").innerText = resumo;
    }
    
    // Envia o pedido via WhatsApp
    function enviarPedido() {
      montarResumo();
      const resumo = document.getElementById("resumoPedido").innerText;
      const mensagem = encodeURIComponent(resumo);
      const url = "https://wa.me/5511984193457?text=" + mensagem;
      window.open(url, "_blank");
    }
    
    // Função para limpar o pedido (reinicia os dados e retorna à Etapa 1)
    function limparPedido() {
      if (confirm("Tem certeza que deseja limpar o pedido?")) {
        pedido.produtos = {
          prontaEntrega: new Array(produtosData.prontaEntrega.length).fill(0),
          encomendas: new Array(produtosData.encomendas.length).fill(0),
          produtosEspeciais: new Array(produtosData.produtosEspeciais.length).fill(0)
        };
        document.getElementById("observacoes").value = "";
        document.getElementById("enderecoFinal").value = "";
        document.getElementById("numero").value = "";
        document.getElementById("complemento").value = "";
        document.getElementById("productList").innerHTML = "";
        atualizarSubtotal();
        alert("Pedido limpo. Você pode recomeçar a seleção no site público.");
        goToStep(1);
      }
    }
    
    // Alterna entre as abas do painel administrativo (as abas do Bootstrap já gerenciam isso)
    function goToStep(stepNumber) {
      document.querySelectorAll(".step").forEach(step => step.classList.remove("active"));
      document.getElementById("step" + stepNumber).classList.add("active");
      if (stepNumber === 4) {
        montarResumo();
      }
    }
    
  </script>
</body>
</html>