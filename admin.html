<!DOCTYPE html>
<html lang="pt-BR">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Painel Administrativo - Bento Mineiro</title>
  <!-- Evita indexação -->
  <meta name="robots" content="noindex">
  <!-- Bootstrap CSS -->
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <!-- Inputmask para formatação de moeda -->
  <script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.8/inputmask.min.js"></script>
  <style>
    body {
      background-color: #f7f7f7;
      font-family: Arial, sans-serif;
      margin: 0;
      padding: 20px;
    }
    /* Centraliza o conteúdo */
    #loginSection, #adminSection {
      max-width: 900px;
      margin: 0 auto;
    }
    #adminSection {
      display: none;
    }
    .nav-tabs .nav-link {
      cursor: pointer;
    }
    .btn {
      margin-top: 5px;
    }
    /* Prévia das imagens */
    #produtoPreview, #editarProdutoPreview {
      max-width: 600px;
      aspect-ratio: 4 / 1;
      object-fit: cover;
      border: 1px solid #ccc;
      margin-top: 10px;
      display: none;
    }
  </style>
</head>
<body>
  <!-- Seção de Login -->
  <div id="loginSection">
    <h2 class="text-center mb-4">Painel Administrativo</h2>
    <div class="card">
      <div class="card-body">
        <h4 class="card-title">Faça o Login</h4>
        <div class="mb-3">
          <label for="loginInput" class="form-label">Login:</label>
          <input type="text" id="loginInput" class="form-control" placeholder="Digite o login">
        </div>
        <div class="mb-3">
          <label for="senhaInput" class="form-label">Senha:</label>
          <input type="password" id="senhaInput" class="form-control" placeholder="Digite a senha">
        </div>
        <button class="btn btn-primary" onclick="validarAdmin()">Entrar</button>
      </div>
    </div>
  </div>

  <!-- Seção Administrativa -->
  <div id="adminSection">
    <!-- Navbar interna do painel -->
    <nav class="navbar navbar-expand-lg navbar-dark bg-dark mb-3">
      <div class="container">
        <span class="navbar-brand">Painel Admin</span>
        <div class="collapse navbar-collapse">
          <ul class="navbar-nav me-auto">
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#produtosTab" role="tab">Produtos</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#categoriasTab" role="tab">Categorias</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#editarTab" role="tab">Editar Produtos</a></li>
            <li class="nav-item"><a class="nav-link" data-bs-toggle="tab" data-bs-target="#planilhaTab" role="tab">Planilha de Pedidos</a></li>
          </ul>
          <button class="btn btn-danger" onclick="sairAdmin()">Sair</button>
        </div>
      </div>
    </nav>
    <div class="tab-content" id="adminTabContent">
      <!-- Aba Produtos -->
      <div class="tab-pane fade show active" id="produtosTab" role="tabpanel">
        <h4>Produtos</h4>
        <div id="listaProdutos"></div>
        <hr>
        <h5>Cadastrar Novo Produto</h5>
        <form id="formProduto">
          <div class="mb-3">
            <label for="produtoNome" class="form-label">Nome:</label>
            <input type="text" id="produtoNome" class="form-control" placeholder="Nome do produto" required>
          </div>
          <div class="mb-3">
            <label for="produtoValor" class="form-label">Valor (R$):</label>
            <input type="text" id="produtoValor" class="form-control" placeholder="Valor" required>
          </div>
          <div class="mb-3">
            <label for="produtoImagem" class="form-label">URL da Imagem:</label>
            <input type="url" id="produtoImagem" class="form-control" placeholder="Link da imagem" required oninput="atualizarPreviewProduto()">
          </div>
          <img id="produtoPreview" src="" alt="Prévia da Imagem">
          <div class="mb-3">
            <label for="produtoCategoria" class="form-label">Categoria:</label>
            <select id="produtoCategoria" class="form-select" required>
              <option value="">Selecione...</option>
              <!-- Preenchido via API -->
            </select>
          </div>
          <button type="submit" class="btn btn-success">Cadastrar Produto</button>
        </form>
      </div>
      
      <!-- Aba Categorias -->
      <div class="tab-pane fade" id="categoriasTab" role="tabpanel">
        <h4>Categorias</h4>
        <div id="listaCategorias"></div>
        <hr>
        <h5>Cadastrar Nova Categoria</h5>
        <form id="formCategoria">
          <div class="mb-3">
            <label for="categoriaNome" class="form-label">Nome:</label>
            <input type="text" id="categoriaNome" class="form-control" placeholder="Nome da categoria" required>
          </div>
          <div class="mb-3">
            <label for="categoriaImagem" class="form-label">URL da Imagem:</label>
            <input type="url" id="categoriaImagem" class="form-control" placeholder="Link da imagem" required>
          </div>
          <button type="submit" class="btn btn-success">Cadastrar Categoria</button>
        </form>
      </div>
      
      <!-- Aba Editar Produtos -->
      <div class="tab-pane fade" id="editarTab" role="tabpanel">
        <h4>Editar Produtos</h4>
        <div id="listaProdutosEditar"></div>
        <hr>
        <h5>Editar Produto</h5>
        <form id="formEditarProduto">
          <div class="mb-3">
            <label for="editarProdutoSelect" class="form-label">Selecione o Produto:</label>
            <select id="editarProdutoSelect" class="form-select" required>
              <option value="">Selecione...</option>
              <!-- Preenchido via API -->
            </select>
          </div>
          <div class="mb-3">
            <label for="editarProdutoNome" class="form-label">Nome:</label>
            <input type="text" id="editarProdutoNome" class="form-control" placeholder="Nome do produto" required>
          </div>
          <div class="mb-3">
            <label for="editarProdutoValor" class="form-label">Valor (R$):</label>
            <input type="text" id="editarProdutoValor" class="form-control" placeholder="Valor" required>
          </div>
          <div class="mb-3">
            <label for="editarProdutoImagem" class="form-label">URL da Imagem:</label>
            <input type="url" id="editarProdutoImagem" class="form-control" placeholder="Link da imagem" required oninput="atualizarPreviewEditar()">
          </div>
          <img id="editarProdutoPreview" src="" alt="Prévia da Imagem">
          <div class="mb-3">
            <label for="editarProdutoCategoria" class="form-label">Categoria:</label>
            <select id="editarProdutoCategoria" class="form-select" required>
              <option value="">Selecione...</option>
              <!-- Preenchido via API -->
            </select>
          </div>
          <button type="submit" class="btn btn-primary">Salvar Alterações</button>
        </form>
      </div>
      
      <!-- Aba Planilha de Pedidos -->
      <div class="tab-pane fade" id="planilhaTab" role="tabpanel">
        <h4>Planilha de Pedidos</h4>
        <p>Clique no botão abaixo para acessar a planilha de pedidos:</p>
        <a href="https://docs.google.com/spreadsheets/d/19Va_8hH83EjT-vyUGt_uCQgB6aITo_BHSkVWeMt8bc8/edit?usp=sharing" target="_blank" class="btn btn-info">Abrir Planilha</a>
      </div>
    </div>
  </div>
  
  <!-- Bootstrap JS (Bundle com Popper) -->
  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/inputmask/5.0.8/inputmask.min.js"></script>
  
  <!-- Configuração da URL da API do Google Apps Script -->
  <script>
    const API_BASE_URL = "https://script.google.com/macros/s/AKfycbw7DBXd8noLHPBVnN4Xhoga3V9KwCOFRcp4CGb0EyrrlrDcAt6k96Gx0vZRrJthqNGdVA/exec";
  </script>
  
  <!-- Código de integração com a API -->
  <script>
    // Credenciais fixas para o admin
    const ADMIN_LOGIN = "BentoMineiro";
    const ADMIN_SENHA = "SantoBento2025";
    
    async function validarAdmin() {
      const login = document.getElementById("loginInput").value;
      const senha = document.getElementById("senhaInput").value;
      if (login === ADMIN_LOGIN && senha === ADMIN_SENHA) {
        document.getElementById("loginSection").style.display = "none";
        document.getElementById("adminSection").style.display = "block";
        await carregarCategoriasNoSelect();
        await carregarListaProdutos();
        await carregarListaCategorias();
        await carregarProdutosMigracao();
        await carregarProdutosEditar();
      } else {
        alert("Login ou senha incorretos.");
      }
    }
    
    function sairAdmin() {
      if (confirm("Deseja realmente sair?")) {
        window.location.reload();
      }
    }
    
    // --- FUNÇÕES PARA PRODUTOS VIA API ---
    
    async function carregarListaProdutos() {
      const container = document.getElementById("listaProdutos");
      container.innerHTML = "";
      try {
        const response = await fetch(API_BASE_URL + "?type=produtos");
        const produtos = await response.json();
        if (!produtos || produtos.length === 0) {
          container.innerHTML = "<p>Nenhum produto cadastrado.</p>";
          return;
        }
        produtos.forEach(produto => {
          const div = document.createElement("div");
          div.className = "card mb-2";
          div.innerHTML = `
            <div class="card-body">
              <h5 class="card-title">${produto.Nome}</h5>
              <p class="card-text">Valor: R$ ${parseFloat(produto.Valor).toFixed(2)}<br>
              Categoria: ${produto.Categoria}</p>
              <p class="card-text">Imagem: <a href="${produto.Imagem}" target="_blank">Ver Imagem</a></p>
              <button class="btn btn-sm btn-secondary" onclick="iniciarEdicaoProduto('${produto.ID}')">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="excluirProduto('${produto.ID}')">Excluir</button>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (error) {
        console.error("Erro ao carregar produtos:", error);
        container.innerHTML = "<p>Erro ao carregar produtos.</p>";
      }
    }
    
    async function cadastrarProduto(produto) {
      try {
        const response = await fetch(API_BASE_URL + "?type=produto", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(produto)
        });
        const result = await response.json();
        return result;
      } catch (error) {
        console.error("Erro ao cadastrar produto:", error);
      }
    }
    
    document.getElementById("formProduto").addEventListener("submit", async function(e) {
      e.preventDefault();
      const produto = {
        nome: document.getElementById("produtoNome").value,
        valor: parseFloat(document.getElementById("produtoValor").value),
        imagem: document.getElementById("produtoImagem").value,
        categoria: document.getElementById("produtoCategoria").value
      };
      const result = await cadastrarProduto(produto);
      if (result && result.result === "success") {
        alert("Produto cadastrado com sucesso!");
        this.reset();
        document.getElementById("produtoPreview").style.display = "none";
        await carregarListaProdutos();
        await carregarProdutosMigracao();
        await carregarProdutosEditar();
      } else {
        alert("Erro ao cadastrar produto.");
      }
    });
    
    function atualizarPreviewProduto() {
      const url = document.getElementById("produtoImagem").value;
      const preview = document.getElementById("produtoPreview");
      if (url) {
        preview.src = url;
        preview.style.display = "block";
      } else {
        preview.style.display = "none";
      }
    }
    
    // --- FUNÇÕES PARA CATEGORIAS VIA API ---
    
    async function carregarListaCategorias() {
      const container = document.getElementById("listaCategorias");
      container.innerHTML = "";
      try {
        const response = await fetch(API_BASE_URL + "?type=categorias");
        const categorias = await response.json();
        if (!categorias || categorias.length === 0) {
          container.innerHTML = "<p>Nenhuma categoria cadastrada.</p>";
          return;
        }
        categorias.forEach(categoria => {
          const div = document.createElement("div");
          div.className = "card mb-2";
          div.innerHTML = `
            <div class="card-body">
              <h5 class="card-title">${categoria.Nome}</h5>
              <p class="card-text">Imagem: <a href="${categoria.Imagem}" target="_blank">Ver Imagem</a></p>
              <button class="btn btn-sm btn-secondary" onclick="editarCategoria('${categoria.ID}')">Editar</button>
              <button class="btn btn-sm btn-danger" onclick="excluirCategoria('${categoria.ID}')">Excluir</button>
            </div>
          `;
          container.appendChild(div);
        });
      } catch (error) {
        console.error("Erro ao carregar categorias:", error);
        container.innerHTML = "<p>Erro ao carregar categorias.</p>";
      }
    }
    
    async function cadastrarCategoria(categoria) {
      try {
        const response = await fetch(API_BASE_URL + "?type=categoria", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(categoria)
        });
        const result = await response.json();
        return result;
      } catch (error) {
        console.error("Erro ao cadastrar categoria:", error);
      }
    }
    
    document.getElementById("formCategoria").addEventListener("submit", async function(e) {
      e.preventDefault();
      const categoria = {
        nome: document.getElementById("categoriaNome").value,
        imagem: document.getElementById("categoriaImagem").value
      };
      const result = await cadastrarCategoria(categoria);
      if (result && result.result === "success") {
        alert("Categoria cadastrada com sucesso!");
        this.reset();
        await carregarListaCategorias();
        await carregarCategoriasNoSelect();
        await carregarProdutosMigracao();
        await carregarProdutosEditar();
      } else {
        alert("Erro ao cadastrar categoria.");
      }
    });
    
    async function carregarCategoriasNoSelect() {
      const selectProduto = document.getElementById("produtoCategoria");
      const selectEditar = document.getElementById("editarProdutoCategoria");
      selectProduto.innerHTML = '<option value="">Selecione...</option>';
      selectEditar.innerHTML = '<option value="">Selecione...</option>';
      try {
        const response = await fetch(API_BASE_URL + "?type=categorias");
        const categorias = await response.json();
        categorias.forEach(c => {
          const option1 = document.createElement("option");
          option1.value = c.Nome;
          option1.innerText = c.Nome;
          selectProduto.appendChild(option1);
          const option2 = document.createElement("option");
          option2.value = c.Nome;
          option2.innerText = c.Nome;
          selectEditar.appendChild(option2);
        });
      } catch (error) {
        console.error("Erro ao carregar categorias para selects:", error);
      }
    }
    
    async function editarCategoria(id) {
      try {
        const response = await fetch(API_BASE_URL + "?type=categorias&id=" + id);
        const categoria = await response.json();
        document.getElementById("categoriaNome").value = categoria.Nome;
        document.getElementById("categoriaImagem").value = categoria.Imagem;
        // Para edição, vamos usar o método DELETE e, em seguida, cadastrar novamente
        await excluirCategoria(id);
        alert("Edite os campos e cadastre a categoria novamente para concluir a edição.");
      } catch (error) {
        console.error("Erro ao editar categoria:", error);
      }
    }
    
    async function excluirCategoria(id) {
      if (confirm("Deseja realmente excluir esta categoria?")) {
        try {
          await fetch(API_BASE_URL + "?type=categoria&id=" + id, { method: "DELETE" });
          alert("Categoria excluída com sucesso!");
          await carregarListaCategorias();
          await carregarCategoriasNoSelect();
          await carregarProdutosMigracao();
          await carregarProdutosEditar();
        } catch (error) {
          console.error("Erro ao excluir categoria:", error);
          alert("Erro ao excluir categoria.");
        }
      }
    }
    
    // --- Aba Editar Produtos ---
    
    async function carregarProdutosMigracao() {
      const select = document.getElementById("editarProdutoSelect");
      select.innerHTML = '<option value="">Selecione...</option>';
      try {
        const response = await fetch(API_BASE_URL + "?type=produtos");
        const produtos = await response.json();
        produtos.forEach(p => {
          const op = document.createElement("option");
          op.value = p.ID;
          op.innerText = p.Nome + " (" + p.Categoria + ")";
          select.appendChild(op);
        });
      } catch (error) {
        console.error("Erro ao carregar produtos para edição:", error);
      }
    }
    
    async function carregarProdutosEditar() {
      const container = document.getElementById("listaProdutosEditar");
      container.innerHTML = "";
      try {
        const response = await fetch(API_BASE_URL + "?type=produtos");
        const produtos = await response.json();
        if (!produtos || produtos.length === 0) {
          container.innerHTML = "<p>Nenhum produto cadastrado.</p>";
          return;
        }
        produtos.forEach(produto => {
          const div = document.createElement("div");
          div.className = "card mb-2";
          div.innerHTML = `
            <div class="card-body">
              <h5 class="card-title">${produto.Nome}</h5>
              <p class="card-text">Valor: R$ ${parseFloat(produto.Valor).toFixed(2)}<br>
              Categoria: ${produto.Categoria}</p>
              <p class="card-text">Imagem: <a href="${produto.Imagem}" target="_blank">Ver Imagem</a></p>
            </div>
          `;
          container.appendChild(div);
        });
        await carregarProdutosMigracao();
      } catch (error) {
        console.error("Erro ao carregar produtos para edição:", error);
        container.innerHTML = "<p>Erro ao carregar produtos.</p>";
      }
    }
    
    // Quando um produto é selecionado para edição, preenche os campos
    document.getElementById("editarProdutoSelect").addEventListener("change", async function() {
      const id = this.value;
      if (!id) return;
      try {
        const response = await fetch(API_BASE_URL + "?type=produto&id=" + id);
        const produto = await response.json();
        document.getElementById("editarProdutoNome").value = produto.Nome;
        document.getElementById("editarProdutoValor").value = produto.Valor;
        document.getElementById("editarProdutoImagem").value = produto.Imagem;
        document.getElementById("editarProdutoCategoria").value = produto.Categoria;
        const preview = document.getElementById("editarProdutoPreview");
        preview.src = produto.Imagem;
        preview.style.display = "block";
      } catch (error) {
        console.error("Erro ao carregar produto para edição:", error);
      }
    });
    
    function atualizarPreviewEditar() {
      const url = document.getElementById("editarProdutoImagem").value;
      const preview = document.getElementById("editarProdutoPreview");
      if (url) {
        preview.src = url;
        preview.style.display = "block";
      } else {
        preview.style.display = "none";
      }
    }
    
    // Atualiza a formatação de moeda
    window.addEventListener("load", () => {
      Inputmask({"alias": "currency", "prefix": "R$ "}).mask(document.getElementById("produtoValor"));
      Inputmask({"alias": "currency", "prefix": "R$ "}).mask(document.getElementById("editarProdutoValor"));
    });
    
    // --- Atualização de Produto (PUT) ---
    document.getElementById("formEditarProduto").addEventListener("submit", async function(e) {
      e.preventDefault();
      const id = document.getElementById("editarProdutoSelect").value;
      if (!id) {
        alert("Selecione um produto para editar.");
        return;
      }
      const produtoAtualizado = {
        id: id,
        nome: document.getElementById("editarProdutoNome").value,
        valor: parseFloat(document.getElementById("editarProdutoValor").value),
        imagem: document.getElementById("editarProdutoImagem").value,
        categoria: document.getElementById("editarProdutoCategoria").value
      };
      try {
        const response = await fetch(API_BASE_URL + "?type=produto", {
          method: "PUT",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify(produtoAtualizado)
        });
        const result = await response.json();
        if (result && result.result === "success") {
          alert("Produto atualizado com sucesso!");
          this.reset();
          document.getElementById("editarProdutoPreview").style.display = "none";
          await carregarProdutosEditar();
          await carregarListaProdutos();
          await carregarProdutosMigracao();
        } else {
          alert("Erro ao atualizar produto: " + (result.error || ""));
        }
      } catch (error) {
        console.error("Erro ao atualizar produto:", error);
        alert("Erro ao atualizar produto.");
      }
    });
    
  </script>
</body>
</html>